---
title: "descriptive-statistics"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Objective

Generate descriptive statistics tables (Table 1) for the following cohorts:

-   [x] OCCAMS
-   [ ] BEST2
-   [ ] Mutographs

# Setup

```{r setup}
library(tidyverse) 
library(table1)
library(kableExtra)
```

```{r read_data}
load('data/original/LabKey-occams_pt-tibble_20220617.RData')
overall_cohort <- occams_pt_20220617
```

```{r find_dupes, include=FALSE}
overall_cohort %>% group_by(ID) %>% filter(n() > 1) %>% summarize(`Number of records` =
                                                           n()) %>% kable(caption = 'OCCAMS IDs with more than one observation in the dataset') %>% kable_styling(full_width = FALSE,
                                               position = 'c',
                                               bootstrap_options = c('striped', 'hover'))
```

# Filter cohort

-   RP.Histology or PS.Histology is adenocarcinoma
    -   RP.Histology == "adenocarcinoma" \| PS.Histology == "adenocarcinoma") %\>% --\> gives 4082

**AND**

-   Surgery was performed
    -   N = 3,122

380 cases are undergoing surveillance

no yes <NA> 1451 380 2600

```{r}
table(overall_cohort$EX.BarrettsOesophagusUndergoingSurveillance, useNA = 'always')
table(overall_cohort$ST.SurgeryPerformed.c, useNA = 'always')
```
## primary filter
```{r filter_data, include=FALSE}
# primary inclusion criteria
filtered_cohort <- overall_cohort %>%
  group_by(ID) %>%
  filter(n() == 1) %>%
  ungroup(.) %>%
  filter(!is.na(DI.ageAtDiagnosis)) %>%
  filter(!is.na(DI.PatientGender)) %>%
  filter(RP.Histology == "adenocarcinoma" | PS.Histology == "adenocarcinoma") %>%
  filter(ST.SurgeryPerformed.c == "yes")

table(filtered_cohort$EX.BarrettsOesophagusUndergoingSurveillance, useNA = "always")

# cross tab surveillance and adjacent status
table(filtered_cohort$RP.BarrettsAdjacentToTumour.c, filtered_cohort$EX.BarrettsOesophagusUndergoingSurveillance, useNA = "always")
table(filtered_cohort$RP.BarrettsAdjacentToTumour.c, useNA = "always")
# for reviewer comments on May 7th, 2025
table(filtered_cohort$RP.BarettsAdjacentToTumourMicroscopicIM, useNA = "always")
table(filtered_cohort$RP.BarettsAdjacentToTumourMacroscopic, useNA = "always")

filtered_cohort |>
  group_by(RP.BarettsAdjacentToTumourMicroscopicIM, 
  RP.BarettsAdjacentToTumourMacroscopic, 
  RP.BarrettsAdjacentToTumour.c) |>
  count() |> 
  kableExtra::kable(row.names = F) |> 
  kableExtra::kable_styling(full_width = F)

filtered_cohort |> 
  filter(EX.BarrettsOesophagusUndergoingSurveillance=='yes') |> 
  write_csv('surverillance-cohort-metadata.csv')
  group_by(StudySite) |> count(sort=T) |> print(n=100)

filtered_cohort |> 
  filter(StudySite %in% c('Cambridge', 'Cambridge ps')) |> 
  write_csv('overall-cohort-metadata-Cambridge.csv')


epitable <- filtered_cohort %>%
  mutate(RP.BarrettsAdjacentToTumour.c = if_else(
    is.na(RP.BarrettsAdjacentToTumour.c),
    "unk",
    as.character(RP.BarrettsAdjacentToTumour.c)
  )) %>%
  mutate(
    EX.BarrettsOesophagusUndergoingSurveillance = if_else(
      is.na(EX.BarrettsOesophagusUndergoingSurveillance),
      "unk",
      as.character(EX.BarrettsOesophagusUndergoingSurveillance)
    )
  )
table1(~ RP.BarrettsAdjacentToTumour.c | EX.BarrettsOesophagusUndergoingSurveillance, epitable)
```

## sensitivity filter
```{r filter_data, include=FALSE}
# secondary exlusion criteria - exclude people who said they're under BO surveillance
# used for sensitivity analysis
filtered_cohort_exclude_bo_surveillance <- overall_cohort %>%
  group_by(ID) %>% filter(n() == 1) %>% ungroup(.) %>%
  filter(!is.na(DI.ageAtDiagnosis)) %>% 
  filter(!is.na(DI.PatientGender)) %>% 
  filter(RP.Histology == "adenocarcinoma" | PS.Histology == "adenocarcinoma") %>%
  filter(ST.SurgeryPerformed.c == "yes") %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA))

table(filtered_cohort$RP.BarrettsAdjacentToTumour.c, filtered_cohort$EX.BarrettsOesophagusUndergoingSurveillance, useNA = 'always')

bo_surveillance <- overall_cohort %>%
  group_by(ID) %>% filter(n() == 1) %>% ungroup(.) %>%
  filter(RP.Histology == "adenocarcinoma" | PS.Histology == "adenocarcinoma") %>%
  filter(ST.SurgeryPerformed.c == "yes") %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes'))


        # no yes <NA>
  # no   398  21  465
  # yes  471 146  623
  # <NA> 226  48  724

# tertiary exclusion criteria - include regardless of surveillance or surgery
# including all cases regardless of surgery adds little to the groups with known BE adjacent status. By dropping 
# surgery as a filter, i only add 9 cases to the OAC-ve and 15 cases to the OAC +ve and these are the "open and shiut" cases so they did not have surgey. So it is really not worth including open/shuts. Plus open/shuts will add 783 cases to the BO (?) OAC which makes that group massive and won't look good
filtered_cohort_include_all_surgery <- overall_cohort %>%
  group_by(ID) %>% filter(n()==1) %>% ungroup(.) %>% 
  filter(RP.Histology == "adenocarcinoma" | PS.Histology == "adenocarcinoma")

table(filtered_cohort_include_all_surgery$RP.BarrettsAdjacentToTumour.c, filtered_cohort_include_all_surgery$ST.SurgeryPerformed.c, useNA = 'always')

epitable_surgery <- filtered_cohort_include_all_surgery %>%
  mutate(RP.BarrettsAdjacentToTumour.c = if_else(
    is.na(RP.BarrettsAdjacentToTumour.c),
    'unk',
    as.character(RP.BarrettsAdjacentToTumour.c)
  )) %>%
  mutate(
    ST.SurgeryPerformed.c = if_else(
      is.na(ST.SurgeryPerformed.c),
      'unk',
    as.character(ST.SurgeryPerformed.c)
    )
  ) 
  table1(~RP.BarrettsAdjacentToTumour.c | ST.SurgeryPerformed.c, epitable_surgery)
```



# Clean data

## pathology

```{r pathology, include=FALSE}
filtered_cohort_clean_path <- bo_surveillance %>%
# filtered_cohort_clean_path <- filtered_cohort %>%
# filtered_cohort_clean_path <- filtered_cohort_exclude_bo_surveillance %>%
  select(
    ID,
    StudySite,
    Weeks.Survival.c,
    RD.DiagnosisDate.c,
    DI.ageAtDiagnosis,
    DI.PatientGender,
    DI.Ethnic.Category,
    EX.PatientOnAcidSuppressant,
    EX.SymptomaticOnAcidSuppressant,
    EX.RefluxFrequencyOfSymptoms,
    EX.DurationOfRefluxSymptoms, #add never
    EX.IsSmoker,
    EX.AverageCigarrettesPerDay, #add logic to create numeric measures
    EX.SmokingDurationYears,
    EX.UnitsPerWeekInTotal,
    EX.HeavyDrinker, 
    EX.CurrentWeightKG,
    EX.CurrentHeightCM,
    EX.5YearsAgoWeightKG,
    EX.BarrettsOesophagusUndergoingSurveillance,
    EX.BarrettsOesophagusDateDiagnosed,
    EX.FamilyHistoryOfOesophagoGastricCancer,
    contains('unitsperweek'),
    contains('EX.NSAIDs'),
    contains('EX.ProtonPump'),
    contains('EX.HistamineType2'), #high missingness, not useful to clean
    contains('EX.OverTheCounter'),
    contains('EX.Asprin'),
    RP.Histology,
    # PS.Histology,
    # PS.TStage.PrimaryTumour.FinalPretreatmentStaging,
    # PS.NStage.PrimaryTumour.FinalPretreatmentStaging.TNM7,
    # PS.MStage.PrimaryTumour.FinalPretreatmentStaging,
    RP.TStage.PrimaryTumour,
    RP.Nstage.RP.TNM7,
    RP.MStage.DistantMetastasis,
    RP.MandardScoreForResponse,
    RP.TumourGradingDifferentiationStatus,
    RP.TumourDifferentiation.c,
    RP.Tumour.Size.length.mm,
    RP.SiewertClassification,
    RP.Location,
    RP.PostOpPathCombinedTumourSite,
    # RP.CircumferentialResectionMargin,
    # RP.LymphoVascularInvasion,
    # TR.CurativeTreatmentModality,
    # ST.Procedure,
    ST.SurgeryPerformed.c,
    RP.BarrettsAdjacentToTumour.c,
    # RP.TumourDifferentiation.c,
    Patient.Died.c,
    ends_with(".c")
  ) %>%
  mutate(
    Phenotype = case_when(
      RP.BarrettsAdjacentToTumour.c == "yes" ~ "BE/IM EAC",
      RP.BarrettsAdjacentToTumour.c == "no" ~ "Non-BE/IM EAC",
      is.na(RP.BarrettsAdjacentToTumour.c) ~ "Unknown BE/IM EAC"
    )
  ) %>% 
  mutate(
  pTStage_Prm_Tmr_f = factor(
    RP.TStage.PrimaryTumour,
    levels = c(
      'Tx',
      'T0',
      'Tis',
      'T1',
      'T1a',
      'T1b',
      'T2',
      'T3',
      'T4',
      'T4a',
      'T4b'
    ),
    ordered = TRUE
  ),
  
  RP.TumourDifferentiation.c = factor(
    RP.TumourDifferentiation.c,
    levels = c('poor',
               'moderate',
               'well'),
    ordered = TRUE
  ),
  
  pTStage_four_f = factor(
    case_when(
      RP.TStage.PrimaryTumour %in% c("T1", "T1a", "T1b") ~ "T1",
      RP.TStage.PrimaryTumour == "T2" ~ "T2",
      RP.TStage.PrimaryTumour == "T3" ~ "T3",
      RP.TStage.PrimaryTumour %in% c("T4", "T4a", "T4b") ~ "T4"
    ),
    levels = c("T1",
               "T2",
               "T3",
               "T4"),
    ordered = TRUE
  ),
  
  pNStage_Prm_Tmr_f = factor(
    RP.Nstage.RP.TNM7,
    levels = c('Nx',
               'N0',
               'N1',
               'N2',
               'N3'),
    ordered = TRUE
  ),
  
  pMStage_Dist_Metas_f = factor(
    RP.MStage.DistantMetastasis,
    levels = c('Mx',
               'M0',
               'M1'),
    ordered = TRUE
  )
) %>%
  
  mutate(
    pTNM_c = case_when((
      (
        pTStage_Prm_Tmr_f %in% c('T1', 'T1a', 'T1b') &
          pNStage_Prm_Tmr_f == 'N0'
      ) |
        (
          pTStage_Prm_Tmr_f == 'T2' &
            pNStage_Prm_Tmr_f == 'N0' &
            RP.TumourDifferentiation.c != 'poor'
        )
    ) ~ "I",
    (
      (
        pTStage_Prm_Tmr_f == 'T2' &
          pNStage_Prm_Tmr_f == 'N0' &
          RP.TumourDifferentiation.c == 'poor'
      ) |
        (pTStage_Prm_Tmr_f == 'T3' & pNStage_Prm_Tmr_f == 'N0') |
        (
          pTStage_Prm_Tmr_f %in% c('T1', 'T1a', 'T1b', 'T2') &
            pNStage_Prm_Tmr_f == 'N1'
        )
    ) ~ "II",
    (
      (
        pTStage_Prm_Tmr_f %in% c('T1', 'T1a', 'T1b', 'T2') &
          pNStage_Prm_Tmr_f == 'N2'
      ) |
        (pTStage_Prm_Tmr_f == 'T3' & pNStage_Prm_Tmr_f == 'N1') |
        (
          pTStage_Prm_Tmr_f %in% c('T4', 'T4a', 'T4b') &
            pNStage_Prm_Tmr_f == 'N0'
        ) |
        (pTStage_Prm_Tmr_f == 'T3' & pNStage_Prm_Tmr_f == 'N2') |
        (
          pTStage_Prm_Tmr_f %in% c('T4', 'T4a', 'T4b') &
            pNStage_Prm_Tmr_f %in% c(NA, 'N1', 'N2')
        ) |
        (pNStage_Prm_Tmr_f == 'N3')
    ) ~ "III"),
    
    pTNM_f = ifelse(pMStage_Dist_Metas_f %in% c(NA, 'Mx', 'M0'), pTNM_c, "IV"),
    #if metastisized, then TNM IV
    
    pTNM_f = factor(
      pTNM_f,
      levels = c("I", "II", "III", "IV"),
      ordered = TRUE
    ),
    
    pTNM_Split_f = ifelse(
      pTNM_f %in% c('I', "II"),
      "[pTNM I/II]",
      ifelse(pTNM_f %in% c('III', "IV"), "[pTNM III/IV]", NA)
    ),
    
    pTNM_Split_f = factor(
      pTNM_Split_f,
      levels = c("[pTNM I/II]", "[pTNM III/IV]"),
      ordered = TRUE
    ),
    
    pTStage_Split_f = factor(
      case_when(
        pTStage_four_f %in% c("T1", "T2") ~ "[T1/2]",
        pTStage_four_f %in% c("T3", "T4") ~ "[T3/4]"
      ),
      levels = c("[T1/2]",
                 "[T3/4]"),
      ordered = TRUE
    ),
    Tumor_Length_CM_n = as.numeric(RP.Tumour.Size.length.mm / 10)
  ) %>% 
    mutate(RP.BarrettsAdjacentToTumour.c = case_when(
                     is.na(RP.BarrettsAdjacentToTumour.c) ~ 'Unknown',
                   TRUE ~ as.character(RP.BarrettsAdjacentToTumour.c))) %>% 
  mutate(Years_Surv = Weeks.Survival.c / 52) %>%
  mutate(Death = case_when(Patient.Died.c == 'yes' ~ 1, TRUE ~ 0))
```

## epidemiology

Common variables:

-   Age
-   Gender
-   BMI
-   Ethnicity
-   Smoking
-   NSAID
-   ACID_SUPPRESSANT
-   Duration_Reflux_Symptoms
-   Phenotype

```{r risk_factors, include=FALSE}
filtered_cohort_clean_path_epid <- filtered_cohort_clean_path %>%
  mutate(age_group = factor(
    case_when(
      DI.ageAtDiagnosis < 50 ~ "< 50 years old",
      DI.ageAtDiagnosis >= 50 &
        DI.ageAtDiagnosis < 60 ~ "50 - 59 years old",
      DI.ageAtDiagnosis >= 60 &
        DI.ageAtDiagnosis < 70 ~ "60 - 69 years old",
      DI.ageAtDiagnosis >= 70 ~ "70+ years old"
      # TRUE ~ age_at_be_diag_or_baseline
      # age_at_be_diag_or_baseline >= 80 ~ "80+ years old"
    ),
    # levels = c(
    #   "< 50 years old",
    #   "50 - 59 years old",
    #   "60 - 69 years old",
    #   "70+ years old"
    #   # "80+ years old"
    # ),
    ordered = TRUE
  )) %>%
  mutate(
    gender = case_when(
      DI.PatientGender == "female" ~ "F",
      DI.PatientGender == "male" ~ "M",
      TRUE ~ DI.PatientGender
    )
  ) %>% 
  mutate(EX.IsSmoker = case_when(
    (
      is.na(EX.IsSmoker) &
        EX.AverageCigarrettesPerDay %in% c('-1', '0')
    ) ~ 'never',
    TRUE ~ EX.IsSmoker
  )) %>%
  mutate(
    smoking_CPD = case_when(
      # clean the CPD
      EX.AverageCigarrettesPerDay %in% c('-1') ~ NA_character_,
      EX.AverageCigarrettesPerDay %in% c('-0') ~ '0',
      EX.AverageCigarrettesPerDay %in% c('0.5') ~ '1',
      EX.AverageCigarrettesPerDay %in% c('1-2', '2 CIGARS', '2 - cigars/day') ~ '2',
      EX.AverageCigarrettesPerDay %in% c('2-3', '2/3', '23') ~ '3',
      EX.AverageCigarrettesPerDay %in% c('3-4') ~ '3',
      EX.AverageCigarrettesPerDay %in% c('40 packs a year, 2 per day') ~ '2',
      EX.AverageCigarrettesPerDay %in% c('4-5', '5 cigar rolls', 'Occasional') ~ '5',
      EX.AverageCigarrettesPerDay %in% c('5-6') ~ '6',
      EX.AverageCigarrettesPerDay %in% c('5-10') ~ '7',
      EX.AverageCigarrettesPerDay %in% c('5-7') ~ '7',
      EX.AverageCigarrettesPerDay %in% c('7-10') ~ '8',
      EX.AverageCigarrettesPerDay %in% c('5-12', '9') ~ '10',
      EX.AverageCigarrettesPerDay %in% c('10-12') ~ '11',
      EX.AverageCigarrettesPerDay %in% c('5-20') ~ '12',
      EX.AverageCigarrettesPerDay %in% c('10-15', '10/15') ~ '13',
      EX.AverageCigarrettesPerDay %in% c('12-15') ~ '13',
      EX.AverageCigarrettesPerDay %in% c('5-25') ~ '15',
      EX.AverageCigarrettesPerDay %in% c('10-20') ~ '15',
      EX.AverageCigarrettesPerDay %in% c('14/15') ~ '15',
      EX.AverageCigarrettesPerDay %in% c('15-20') ~ '18',
      EX.AverageCigarrettesPerDay %in% c('20, stopped 30yrs ago') ~ '20',
      EX.AverageCigarrettesPerDay %in% c('20-30') ~ '25',
      EX.AverageCigarrettesPerDay %in% c('25-30') ~ '27',
      EX.AverageCigarrettesPerDay %in% c('20-40') ~ '30',
      EX.AverageCigarrettesPerDay %in% c('30-40') ~ '35',
      EX.AverageCigarrettesPerDay %in% c('60-80') ~ '70',
      TRUE ~ EX.AverageCigarrettesPerDay
    )
  ) %>%
  mutate(smoking_CPD = as.double(smoking_CPD)) %>%
  mutate(smoking_CPD = case_when(smoking_CPD <= 0 ~ NA_integer_,
                                 TRUE ~ as.integer(smoking_CPD))) %>%
  mutate(EX.IsSmoker = case_when(
    (EX.IsSmoker %in% c('never', NA) & smoking_CPD > 0 ) ~ 'former',
    TRUE ~ EX.IsSmoker)) %>% 
  mutate(smoking_NPY = (smoking_CPD / 20) * (EX.SmokingDurationYears)) %>% # calculate pack-years
  mutate(smoking_CPD = na_if(smoking_CPD, 0)) %>%
  mutate(smoking_duration_yrs = na_if(EX.SmokingDurationYears, 0.000)) %>%
  mutate(smoking_NPY = na_if(smoking_NPY, 0)) %>%
  mutate(
  EX.RefluxFrequencyOfSymptoms_f = factor(
    EX.RefluxFrequencyOfSymptoms,
    levels = c("never", "sometimes", "often","daily"),
    ordered = TRUE
  ),
  
  EX.IsSmoker_f = factor(
    EX.IsSmoker, levels = c('never', 'current', 'former'),
    ordered = TRUE
  ),
  
  Smoker_Ever = factor(case_when(
    EX.IsSmoker %in% c('current', 'former') ~ 'ever',
    EX.IsSmoker_f == 'never' ~ 'never'),
    levels = c('never', 'ever'),
    ordered = TRUE
  ),
  
  EX.DurationOfRefluxSymptoms_f = factor(
    EX.DurationOfRefluxSymptoms,
    levels = c("< 5 years", "5-10 years", "> 10 years"),
    ordered = TRUE
  ),

  EX.DurationOfRefluxSymptoms_f = factor(case_when(
    EX.RefluxFrequencyOfSymptoms_f == 'never' ~ 'never',
    EX.RefluxFrequencyOfSymptoms_f %in% c("sometimes", "often","daily") & is.na(EX.DurationOfRefluxSymptoms_f) ~ 'unknown',
    TRUE ~ EX.DurationOfRefluxSymptoms), 
    levels = c('never', '< 5 years', '5-10 years', '> 10 years', 'unknown'), 
    ordered = TRUE),
  
  EX.RefluxFrequencyOfSymptoms_f = factor(case_when(
    EX.DurationOfRefluxSymptoms_f %in%  c("< 5 years", "5-10 years", "> 10 years") & is.na(EX.RefluxFrequencyOfSymptoms_f) ~ 'unknown',
    TRUE ~ EX.RefluxFrequencyOfSymptoms), 
    levels = c("never", "sometimes", "often","daily", 'unknown'), 
    ordered = TRUE),

  Reflux_Ever_f = factor(case_when(
    EX.RefluxFrequencyOfSymptoms_f %in% c("daily", "often", "sometimes") |
      EX.DurationOfRefluxSymptoms_f %in% c("< 5 years", "5-10 years", "> 10 years") ~ "ever",
    EX.RefluxFrequencyOfSymptoms_f == "never" & is.na(EX.DurationOfRefluxSymptoms_f) ~ "never"),
    levels = c('never', 'ever'),
    ordered = TRUE
  ),
  
  EX.5YearsAgoWeightKG = ifelse(EX.5YearsAgoWeightKG <= 20.0, NA, EX.5YearsAgoWeightKG),
  
  EX.CurrentWeightKG = ifelse(EX.CurrentWeightKG <= 20.0, NA, EX.CurrentWeightKG),
  
  BMI_5yrs_Ago_n = as.double((EX.5YearsAgoWeightKG) / ((EX.CurrentHeightCM / 100.0) ^ 2)),
  
  BMI_n = as.double((EX.CurrentWeightKG) / ((EX.CurrentHeightCM/100.0) ^ 2)),
  
BMI_n = case_when(
  BMI_n == 0.0 ~ NA_integer_,
  BMI_n > 70.0 ~ NA_integer_,
  TRUE ~ as.integer(BMI_n)
),
  BMI_Diff_n = as.numeric(BMI_n - BMI_5yrs_Ago_n),
  
  BMI_Class_5yrs_Ago_f = factor(
    case_when(
      BMI_5yrs_Ago_n < 18.5 ~ "underweight",
      BMI_5yrs_Ago_n >= 18.5 & BMI_5yrs_Ago_n <= 24.9 ~ "normal",
      BMI_5yrs_Ago_n >= 25.0 & BMI_5yrs_Ago_n <= 29.9 ~ "overweight",
      BMI_5yrs_Ago_n >= 30.0 ~ "obese"
    ),
    levels = c("underweight", "normal", "overweight", "obese"),
    ordered = TRUE
  ), 
  
  BMI_Class_f = factor(
    case_when(
      BMI_n < 18.5 ~ "underweight",
      BMI_n >= 18.5 & BMI_n <= 24.9 ~ "normal",
      BMI_n >= 25.0 & BMI_n <= 29.9 ~ "overweight",
      BMI_n >= 30.0 ~ "obese"
    ),
    levels = c("underweight", "normal", "overweight", "obese"),
    ordered = TRUE
  ),
  
  BMI_Obese_f = factor(
    case_when(
      BMI_Class_f == 'obese' ~ 'obese',
      BMI_Class_f %in% c("underweight", "normal", "overweight") ~ 'not obese'
    ),      
    levels = c("not obese", "obese"),
    ordered = TRUE
  )
) %>%
  unite(
    'BMI_Class_5yrs_To_Dx_f',
    sep = " -> ",
    c(BMI_Class_5yrs_Ago_f, BMI_Class_f),
    remove = FALSE
  ) %>%
  mutate(Ethnicity_temp = na_if(DI.Ethnic.Category, 'Z')) %>% # Set ethnicity to NA if unknown
  mutate(Ethnicity_temp = na_if(Ethnicity_temp, '99')) %>%
  mutate(Ethnicity = case_when(
    Ethnicity_temp %in% c('A', 'B', 'C') ~ 'White',
    Ethnicity_temp %in% c('D', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'R', 'S') ~ 'Other'
  )) %>% 

  rowwise() %>% 
  mutate(EX.UnitsPerWeekInTotal = sum(EX.UnitsPerWeekOfWine, EX.UnitsPerWeekOfBeer, EX.UnitsPerWeekOfSpirits, na.rm = F))  %>%  
  mutate(EX.UnitsPerWeekInTotal = na_if(EX.UnitsPerWeekInTotal, 0))
```

## medications

-   Clean medication use variables
    -   PPI use and duration (years)
    -   NSAID use and duration (years)
    -   OTC acid suppressant use and duration (years)
-   clean up the durations by converting all measures into a single duartion with years as unit
  -   I have checked to see if I can use duration to convert NA frequncies into EVER - **this is not worth doing because there are 1 or 2 cases that have a non-zero duration but missing a frequency response**.
```{r med_clean, include=FALSE}

filtered_cohort_clean_path_epid_meds <- filtered_cohort_clean_path_epid %>%
  mutate(
    EX.NSAIDsDurationMonths_Yr = EX.NSAIDsDurationMonths / 12,
    EX.NSAIDsDurationWeeks_Yr = EX.NSAIDsDurationWeeks / 52,
    EX.NSAIDsDurationDays_Yr = EX.NSAIDsDurationDays / 365,
    
    EX.AsprinDurationMonths_Yr = EX.AsprinDurationMonths / 12,
    EX.AsprinDurationWeeks_Yr = EX.AsprinDurationWeeks / 52,
    EX.AsprinDurationDays_Yr = EX.AsprinDurationDays / 365, 
    
    EX.ProtonPumpInhibitorDurationMonths_Yr = EX.ProtonPumpInhibitorDurationMonths / 12,
    EX.ProtonPumpInhibitorDurationWeeks_Yr = EX.ProtonPumpInhibitorDurationWeeks / 52,
    EX.ProtonPumpInhibitorDurationDays_Yr = EX.ProtonPumpInhibitorDurationDays / 365,
    
    EX.OverTheCounterAcidSuppressantsDurationMonths_Yr = EX.OverTheCounterAcidSuppressantsDurationMonths / 12,
    EX.OverTheCounterAcidSuppressantsDurationWeeks_Yr = EX.OverTheCounterAcidSuppressantsDurationWeeks / 52,
    EX.OverTheCounterAcidSuppressantsDurationDays_Yr = EX.OverTheCounterAcidSuppressantsDurationDays / 365,
    
    EX.HistamineType2ReceptorAntagonistDurationMonths_Yr = EX.HistamineType2ReceptorAntagonistDurationMonths / 12,
    EX.HistamineType2ReceptorAntagonistDurationWeeks_Yr = EX.HistamineType2ReceptorAntagonistDurationWeeks / 52,
    EX.HistamineType2ReceptorAntagonistDurationDays_Yr = EX.HistamineType2ReceptorAntagonistDurationDays / 365,
    
  ) %>%
  rowwise() %>%
  mutate(
    NSAIDs_Total_Years = sum(
      EX.NSAIDsDurationYears,
      EX.NSAIDsDurationMonths_Yr,
      EX.NSAIDsDurationWeeks_Yr,
      EX.NSAIDsDurationDays_Yr,
      na.rm = TRUE
    ),
    
    Aspirin_Total_Years = sum(
      EX.AsprinDurationYears,
      EX.AsprinDurationMonths_Yr,
      EX.AsprinDurationWeeks_Yr,
      EX.AsprinDurationDays_Yr,
      na.rm = TRUE
    ), 
    
    PPI_Total_Years = sum(
      EX.ProtonPumpInhibitorDurationYears,
      EX.ProtonPumpInhibitorDurationMonths_Yr,
      EX.ProtonPumpInhibitorDurationWeeks_Yr,
      EX.ProtonPumpInhibitorDurationDays_Yr,
      na.rm = TRUE
    ),
    
    OTCAcidSupp_Total_Years = sum(
      EX.OverTheCounterAcidSuppressantsDurationYears,
      EX.OverTheCounterAcidSuppressantsDurationMonths_Yr,
      EX.OverTheCounterAcidSuppressantsDurationWeeks_Yr,
      EX.OverTheCounterAcidSuppressantsDurationDays_Yr,
      na.rm = TRUE
    ),
    
    H2RA_Total_Years = sum(
      EX.HistamineType2ReceptorAntagonistDurationYears,
      EX.HistamineType2ReceptorAntagonistDurationMonths_Yr,
      EX.HistamineType2ReceptorAntagonistDurationWeeks_Yr,
      EX.HistamineType2ReceptorAntagonistDurationDays_Yr,
      na.rm = TRUE
    ),
    
  ) %>% 
  mutate(NSAIDs = case_when(
  EX.NSAIDs %in% c('never', 'no') ~ 'never',
  EX.NSAIDs %in% c('past use', 'occasional use', 'current use') ~ 'ever'
)) %>%
  mutate(EX.Asprin = case_when(
  EX.Asprin %in% c('never', 'no') ~ 'never',
  EX.Asprin %in% c('past use', 'occasional use', 'current use') ~ 'ever'
)) %>%  
  mutate(EX.ProtonPumpInhibitor = case_when(
  EX.ProtonPumpInhibitor %in% c('never', 'no') ~ 'never',
  EX.ProtonPumpInhibitor %in% c('past use', 'occasional use', 'current use') ~ 'ever'
)) %>%
  mutate(EX.OverTheCounterAcidSuppressants = case_when(
  EX.OverTheCounterAcidSuppressants %in% c('never', 'no') ~ 'never',
  EX.OverTheCounterAcidSuppressants %in% c('past use', 'occasional use', 'current use') ~ 'ever'
)) %>%
  mutate(EX.HistamineType2ReceptorAntagonist = case_when(
  EX.HistamineType2ReceptorAntagonist %in% c('never', 'no') ~ 'never',
  EX.HistamineType2ReceptorAntagonist %in% c('past use', 'occasional use', 'current use') ~ 'ever'
)) %>%
  
  mutate(TAKEN_NSAIDS = case_when(
      NSAIDs %in% c('ever') | EX.Asprin %in% c('ever') ~ "Y",
      TRUE ~ "N"
    ),
    TAKEN_NSAIDS = if_else(is.na(NSAIDs) & is.na(EX.Asprin), "NA", TAKEN_NSAIDS),
    TAKEN_NSAIDS = na_if(TAKEN_NSAIDS, "NA")) %>% 
  
  mutate(NSAIDs_Total_Years_n = na_if(NSAIDs_Total_Years, 0.000000)) %>% 
  mutate(Aspirin_Total_Years_n = na_if(Aspirin_Total_Years, 0.000000)) %>% 
  mutate(PPI_Total_Years_n = na_if(PPI_Total_Years, 0.000000)) %>% 
  mutate(OTCAcidSupp_Total_Years_n = na_if(OTCAcidSupp_Total_Years, 0.000000)) %>% 
  mutate(H2RA_Total_Years_n = na_if(H2RA_Total_Years, 0.000000)) %>% 
  
  mutate(    
    ACID_SUPPRESSANT = case_when(
      EX.ProtonPumpInhibitor %in% c("ever") |
        EX.HistamineType2ReceptorAntagonist %in% c("ever") |
          EX.PatientOnAcidSuppressant %in% c("yes") |
            EX.OverTheCounterAcidSuppressants %in% c("ever") ~ "Y",
      TRUE ~ "N"
    ),
    ACID_SUPPRESSANT = if_else(
      is.na(EX.ProtonPumpInhibitor) &
        is.na(EX.HistamineType2ReceptorAntagonist) &
          is.na(EX.PatientOnAcidSuppressant) &
            is.na(EX.OverTheCounterAcidSuppressants),
      "NA",
      ACID_SUPPRESSANT
    ),
    ACID_SUPPRESSANT = na_if(ACID_SUPPRESSANT, "NA")
  ) %>%
  select(
    -c(
      EX.NSAIDsDurationYears,
      EX.NSAIDsDurationMonths,
      EX.NSAIDsDurationWeeks,
      EX.NSAIDsDurationDays,
      EX.NSAIDsDurationMonths_Yr,
      EX.NSAIDsDurationWeeks_Yr,
      EX.NSAIDsDurationDays_Yr,
      EX.ProtonPumpInhibitorDurationYears,
      EX.ProtonPumpInhibitorDurationMonths,
      EX.ProtonPumpInhibitorDurationWeeks,
      EX.ProtonPumpInhibitorDurationDays,
      EX.ProtonPumpInhibitorDurationMonths_Yr,
      EX.ProtonPumpInhibitorDurationWeeks_Yr,
      EX.ProtonPumpInhibitorDurationDays_Yr,
      EX.OverTheCounterAcidSuppressantsDurationYears,
      EX.OverTheCounterAcidSuppressantsDurationMonths,
      EX.OverTheCounterAcidSuppressantsDurationWeeks,
      EX.OverTheCounterAcidSuppressantsDurationDays,
      EX.OverTheCounterAcidSuppressantsDurationMonths_Yr,
      EX.OverTheCounterAcidSuppressantsDurationWeeks_Yr,
      EX.OverTheCounterAcidSuppressantsDurationDays_Yr,
      EX.HistamineType2ReceptorAntagonistDurationYears,
      EX.HistamineType2ReceptorAntagonistDurationMonths,
      EX.HistamineType2ReceptorAntagonistDurationWeeks,
      EX.HistamineType2ReceptorAntagonistDurationDays,
      PPI_Total_Years,
      OTCAcidSupp_Total_Years,
      H2RA_Total_Years,
      Aspirin_Total_Years,
      NSAIDs_Total_Years
    )
  )
```

## reflux inference

```{r reflux, include=FALSE}
filtered_cohort_clean_path_epid_meds_reflux <- filtered_cohort_clean_path_epid_meds %>%
  mutate(heartburn_inferred_bin =
           case_when(
             (
               EX.DurationOfRefluxSymptoms_f %in% c('< 5 years', '5-10 years', '> 10 years', 'unknown') |
                 EX.RefluxFrequencyOfSymptoms_f %in% c("sometimes", "often", "daily", 'unknown') |
                 ACID_SUPPRESSANT == 'Y'
             ) ~ 'Y',
             (
               is.na(EX.DurationOfRefluxSymptoms_f)  &
                 is.na(EX.RefluxFrequencyOfSymptoms_f) &
                 is.na(ACID_SUPPRESSANT)
             ) ~ NA_character_,
             
             TRUE ~ 'N'
           ))
```

# Descriptive stats

```{r desc_data, include=FALSE}
occams_descriptive_statisitics_table_one <- filtered_cohort_clean_path_epid_meds_reflux %>%
  select(
    ID,
    
    DI.ageAtDiagnosis,
    age_group, 
    DI.PatientGender,
    Ethnicity, 
    
    BMI_n,
    BMI_Class_f,
    BMI_5yrs_Ago_n,
    BMI_Class_5yrs_Ago_f,
    BMI_Diff_n,
    
    Smoker_Ever,
    smoking_CPD,
    smoking_duration_yrs,
    smoking_NPY, 
    
    EX.HeavyDrinker, 
    EX.UnitsPerWeekInTotal,
    
    EX.DurationOfRefluxSymptoms_f,
    EX.RefluxFrequencyOfSymptoms_f,
    EX.PatientOnAcidSuppressant,
    EX.SymptomaticOnAcidSuppressant,
    EX.ProtonPumpInhibitor,
    PPI_Total_Years_n,
    # PPI_Total_Years,
    EX.OverTheCounterAcidSuppressants,
    OTCAcidSupp_Total_Years_n,
    # OTCAcidSupp_Total_Years,
    EX.HistamineType2ReceptorAntagonist,
    H2RA_Total_Years_n,
    # H2RA_Total_Years,
    ACID_SUPPRESSANT,
    heartburn_inferred_bin,
    
    EX.Asprin,
    Aspirin_Total_Years_n,
    NSAIDs,
    NSAIDs_Total_Years_n,
    TAKEN_NSAIDS,
    
    RP.BarrettsAdjacentToTumour.c,
    Tumor_Length_CM_n,
    RP.SiewertClassification, 
    RP.TumourDifferentiation.c, 
    RP.Location,
    RP.PostOpPathCombinedTumourSite,
    pTStage_four_f,
    pTNM_f, 
    RP.PS.Tumour.Diff.c,
    RP.Tumour.Growth.c,
    ST.SurgeryPerformed.c,
    
    EX.BarrettsOesophagusUndergoingSurveillance,
    Death, 
    Years_Surv
  ) %>%
  rename(
    # Age = DI.ageAtDiagnosis,
    # Gender = DI.PatientGender,
    # BMI = BMI_n,
    # Obesity = BMI_Obese_f,
    # Smoking = Smoker_Ever,
    # `Reflux Symptoms Frequency` = ,
    # `Reflux Symptoms Duration` = EX.DurationOfRefluxSymptoms_f,
    # `PPI Use` = EX.ProtonPumpInhibitor,
    # `PPI Use Duration (years)` = PPI_Total_Years_n,
    # `OTC Acid Suppres. Use` = EX.OverTheCounterAcidSuppressants,
    # `OTC Acid Suppres. Use Duration (years)` = OTCAcidSupp_Total_Years_n,
    # `NSAID Use` = NSAIDs,
    # `NSAID Use Duration (years)` = NSAIDs_Total_Years_n,
    Phenotype = RP.BarrettsAdjacentToTumour.c,
    # `Tumor Length (cm)` = Tumor_Length_CM_n,
    # TNM = pTNM_f
  )
```

```{r desc_table_data, echo=FALSE, fig.align='center'}
occams_table1_data <- occams_descriptive_statisitics_table_one  %>%  select(-ID) %>% filter(!is.na(DI.ageAtDiagnosis))
  filter(age_group!='< 50 years old')
# %>% filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes'))

occams_table1 <- table1::table1(~ . | Phenotype,
  data = occams_table1_data,
  render.continuous = c(. = "Mean [SD]", . = "Median [Q1, Q3]"))
  # render.missing=NULL,
  # render.categorical="FREQ (PCTnoNA%)")
```

```{r desc_table, echo=FALSE, fig.align='center'}
occams_table1
```

## save dateset
### primary dataset
```{r save_cleaned_data}
# write_csv(filtered_cohort_clean_path_epid_meds_reflux, 'data/processed/chapter.2_cleaned-occams-data_20230119.csv')
# filtered_cohort_clean_path_epid_meds_reflux <- read_csv('data/processed/chapter.2_cleaned-occams-data_20230119.csv')
```


### sensitivity dataset
```{r save_cleaned_data}
# write_csv(filtered_cohort_clean_path_epid_meds_reflux, 'data/processed/chapter.2_cleaned-occams-data_filtered_cohort-exclude_bo_surveillance_20230213.csv')
```

### regression dataset

```{r}
occams_cohort <-
  filtered_cohort_clean_path_epid_meds_reflux %>%
  select(
    ID,
    Phenotype,
    age = DI.ageAtDiagnosis,
    age_group,
    gender = DI.PatientGender,
    ethnicity = Ethnicity,
    bmi = BMI_n,
    bmi_group = BMI_Class_f,
    smk_ever_smoked = Smoker_Ever,
    taken_nsaids = TAKEN_NSAIDS,
    # NSAID_DURATION_YRS,
    acid_suppressant = ACID_SUPPRESSANT,
    duration_since_heartburn_start = EX.DurationOfRefluxSymptoms_f,
    heartburn_inferred_bin,
    pTStage_four_f,
    pTNM_f,
    RP.SiewertClassification
  ) 

```

### survival dataset

```{r}
occams_cohort_survival <- filtered_cohort_clean_path_epid_meds_reflux %>% 
    filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC", "Unknown BE/IM EAC")) %>%
    select(
    ID,
    Phenotype,
    age = DI.ageAtDiagnosis,
    age_group,
    gender = DI.PatientGender,
    ethnicity = Ethnicity,
    bmi = BMI_n,
    bmi_group = BMI_Class_f,
    smk_ever_smoked = Smoker_Ever,
    taken_nsaids = TAKEN_NSAIDS,
    # NSAID_DURATION_YRS,
    acid_suppressant = ACID_SUPPRESSANT,
    duration_since_heartburn_start = EX.DurationOfRefluxSymptoms_f,
    heartburn_inferred_bin,
    pTStage_four_f,
    pTNM_f,
    RP.SiewertClassification,
    EX.BarrettsOesophagusUndergoingSurveillance,
    Weeks.Survival.c, 
    Years_Surv, 
    Patient.Died.c
  )

```

```{r}
# write_csv(occams_cohort, 'data/processed/chapter.2_regression_occams-cohort_cleaned-data_20230119.csv')
# write_csv(occams_cohort, 'data/processed/chapter.2_regression_occams-cohort_cleaned-data_20221215.csv')
# write_csv(occams_cohort, 'data/processed/chapter.2_regression_occams-cohort_cleaned-filtered_cohort-excludes_bo_surveillance_20230213.csv')
# write_csv(occams_cohort_survival, 'data/processed/chapter.2_survival-analysis_occams-cohort_cleaned-data_20230227.csv')
```

# reflux data for meeting with HGC
```{r}
reflux <-
  read_csv(
    'data/processed/chapter.2_cleaned-occams-data_20230119.csv') %>%
  select(
    Phenotype,
    heartburn_inferred_bin,
    EX.DurationOfRefluxSymptoms_f,
    EX.RefluxFrequencyOfSymptoms_f,
    EX.PatientOnAcidSuppressant,
    EX.SymptomaticOnAcidSuppressant, # dropped after meeting HGC
    EX.ProtonPumpInhibitor,
    EX.HistamineType2ReceptorAntagonist,
    EX.OverTheCounterAcidSuppressants,
    ACID_SUPPRESSANT
  ) %>% 
  # mutate(heartburn_inferred_bin = replace_na(heartburn_inferred_bin, 'missing'))
  mutate(across(.cols = c(2:9), ~ as.character(.x))) %>% 
  dplyr::mutate(across(.cols = c(2:9), ~ replace_na(.x, "z_missing")))  # run to recode implicit NA to "unknown"

```

## Would like to see cross-tabs of the reflux, acid suppressant and any anti-reflux medication use (regardless of BO positive/negative status) to understand what % of patients are reflux only, OTC meds only, etc.

```{r}
table1::table1(
  ~ heartburn_inferred_bin |
    ACID_SUPPRESSANT + EX.PatientOnAcidSuppressant,
  data = reflux,
  overall = F
)
```


```{r}
reflux %>% group_by(
  # EX.PatientOnAcidSuppressant,
                 EX.RefluxFrequencyOfSymptoms_f,
                 EX.DurationOfRefluxSymptoms_f
  # EX.SymptomaticOnAcidSuppressant
  # heartburn_inferred_bin,
  # EX.ProtonPumpInhibitor,
  # EX.HistamineType2ReceptorAntagonist,
  # EX.OverTheCounterAcidSuppressants
) %>%
  count() %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

```{r}
library(UpSetR)
upset(reflux, nsets = n_var_miss(reflux))
table1::table1(~. | Phenotype, data = reflux)
```

```{r}
library(finalfit) 


independent_xt = c(
"heartburn_inferred_bin"
# "EX.DurationOfRefluxSymptoms_f"
# "EX.RefluxFrequencyOfSymptoms_f",
# "EX.PatientOnAcidSuppressant"
# "EX.ProtonPumpInhibitor",
# # "EX.HistamineType2ReceptorAntagonist",
# "EX.OverTheCounterAcidSuppressants",
# "ACID_SUPPRESSANT"

)
dependent_xt = "ACID_SUPPRESSANT"
reflux %>%
  summary_factorlist(dependent_xt, independent_xt,na_include_dependent = T) %>% 
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

```{r}
occams_descriptive_statisitics_table_one %>% 
  ggplot(aes(EX.DurationOfRefluxSymptoms_f)) +
  geom_bar()
```

```{r}
sites <- filtered_cohort_clean_path_epid_meds_reflux %>% 
  mutate(StudySite = if_else(StudySite == 'Cambridge ps', 'Cambridge', StudySite)) %>% 
  group_by(StudySite, Phenotype) %>% 
  mutate(Freq_unknown = n())
 
tab <- data.frame(xtabs(~ StudySite + Phenotype, data = sites))
sites %>% 
  ggplot() +
  geom_bar(aes(x = reorder(StudySite, -Freq_unknown), fill = Phenotype), position = 'fill') +
  geom_text(data = tab, aes(x = StudySite, y = Phenotype, label = Freq), 
            position = position_fill( vjust = .25)) +
  theme(axis.text.x=element_text(angle=45, hjust=1))



filtered_cohort_clean_path_epid_meds_reflux %>% 
  group_by(StudySite, Phenotype)


table1::table1()

table1::table1(~ StudySite | Phenotype, data = sites, row_wise = TRUE)

library(finalfit)

sites %>% 
  finalfit::summary_factorlist(dependent = 'Phenotype', explanatory = 'StudySite',  column = FALSE, total_col = T, orderbytotal = T) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)
```

# Thesis correction
## distribution of phenotype by site

```{r}
filtered_cohort_clean_path_epid_meds_reflux <- read_csv('data/processed/chapter.2_cleaned-occams-data_20230119.csv')

hospitals <- read_csv('data/chapter-4-data/sites/sites_hospitals.csv')
sites <- filtered_cohort_clean_path_epid_meds_reflux %>%
  mutate(Participants = 'Participants') %>%
  mutate(StudySite = if_else(StudySite == 'Cambridge ps', 'Cambridge', StudySite)) %>%
  mutate(StudySite = if_else(StudySite %in% c('Southampton other', 'Other'), 'Southampton', StudySite)) %>%
  mutate(
    region = case_when(
      StudySite %in% c(
        "Birmingham",
        "Coventry",
        "Heartlands",
        "North stafford",
        "Worcester"
      ) ~ "West Midlands (England)",
      StudySite %in% c(
        "Bournemouth",
        "Gloucester",
        "Plymouth"
      ) ~ "South West (England)",
      StudySite == "Belfast" ~ "Northern Ireland",
      StudySite %in% c("Cambridge", "Norwich") ~ "East of England",
      StudySite %in% c("Dundee", "Edinburgh", "Kilmarnock") ~ "Scotland",
      StudySite %in% c("Imperial college", "St thomas london", "Ucl", "Romford") ~ "London",
      StudySite %in% c("Nottingham") ~ "East Midlands (England)",
      StudySite %in% c("Salford", "Wigan", "Wythenshaw") ~ "North West (England)",
      StudySite %in% c("Guildford", "Portsmouth", "Southampton", "Southampton other") ~ "South East (England)",
      TRUE ~ "Other"
    )
  )

left_join(sites, hospitals, "StudySite") %>% 
  group_by(region, StudySite, Hospital) %>% 
  count(sort = F) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)



sites %>% group_by(region) %>% count(sort = T)

table1::table1(~ StudySite | Participants, data = sites, row_wise = TRUE)
table1::table1(~ region | Participants, data = sites, row_wise = FALSE)


sites %>% 
  filter(Phenotype != 'Unknown BE/IM EAC') %>%
  finalfit::summary_factorlist(dependent = 'Phenotype', explanatory = 'region',  column = TRUE, total_col = T, orderbytotal = T) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)


sites %>%
  # filter(Phenotype != 'Unknown BE/IM EAC') %>%
  select(
    c(
      'region',
      'age_group',
      'gender',
      'BMI_Class_f',
      'Smoker_Ever',
      'TAKEN_NSAIDS',
      'heartburn_inferred_bin',
      'pTNM_f'
    )
  ) %>%
  mutate(across(.cols = c(4:8), ~ as.character(.x))) %>%
  mutate(across(.cols = c(4:8), ~ replace_na(.x, "z_missing"))) %>%
  finalfit::summary_factorlist(
    dependent = 'region',
    explanatory = c(
      'age_group',
      'gender',
      'BMI_Class_f',
      'Smoker_Ever',
      'TAKEN_NSAIDS',
      'heartburn_inferred_bin',
      'pTNM_f'
    ),
    column = TRUE,
    # na_include = TRUE,
    # na_to_prop = TRUE,
    total_col = T,
    # orderbytotal = T
  ) %>%
  select(-label) %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(full_width = F)

```

## Map

```{r}
library(ggplot2)
library(maps)
library(ggmap)

# Get the map of the UK using the "maps" package
uk_map <- map_data("world", "UK")


# Create a data frame with the recruiting centers and corresponding number of cases

recruiting_centers <- data.frame(
  center = c("Belfast", "Birmingham", "Bournemouth", "Cambridge", "Coventry",
             "Dundee", "Edinburgh", "Gloucester", "Guildford", "Heartlands",
             "Imperial college", "Kilmarnock", "North stafford", "Norwich", "Nottingham",
             "Southampton", "Plymouth", "Portsmouth", "Romford", "Salford",
             "St thomas london", "Ucl", "Wigan", "Worcester", "Wythenshaw"),
  cases = c(100, 212, 8, 471, 86, 10, 296, 44, 156, 20,
            80, 2, 31, 126, 318, 203, 2, 33, 104, 313,
            356, 52, 6, 12, 29),
  lon = c(-5.9345, -1.8904, -1.9093, 0.1198, -1.5077,
          -3.0193, -3.1883, -2.2215, -0.5705, -1.8316,
          -0.1749, -4.4961, -2.1927, 1.1536, -1.1432,
          -1.4044, -4.1431, -1.0801, 0.1821, -2.3886,
          -0.1169, -0.1344, -2.6115, -2.2191, -2.2914),
  lat = c(54.5973, 52.4862, 50.7192, 52.2053, 52.4068,
          56.4620, 55.9533, 51.8642, 51.2362, 52.4583,
          51.4989, 55.6079, 53.0320, 52.6309, 52.9550,
          50.9097, 50.3755, 50.8198, 51.5777, 53.4875,
          51.4988, 51.5244, 53.5450, 52.1936, 53.3896)
)

# write for tableau
write_csv(recruiting_centers, 'data/processed/map_data_occams_paper.csv')


# Get the map background of the UK using the "ggmap" package
register_google(key = "AIzaSyCOlJ1Al-bgeadiE8_G4Jg6pcTHHbydeco", write = TRUE)
has_google_key()
google_key()
has_google_client()
has_google_signature()
uk_map_background <- get_map(location = "United Kingdom", zoom = 5, scale = 1, color = 'bw')

# Create a map plot with bubble markers
ggmap(uk_map_background) +
  geom_point(
    data = recruiting_centers,
    aes(x = lon, y = lat, size = cases),
    alpha = .4,
    color = 'red'
  ) +
  scale_size(range = c(1, 10)) +
  geom_map(
    data = uk_map,
    map = uk_map,
    aes(x = long, y = lat, map_id = region),
    fill = "transparent",
    color = "black",
  ) 


```

