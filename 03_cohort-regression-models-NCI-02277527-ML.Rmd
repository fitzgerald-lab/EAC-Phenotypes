---
title: "cohort-regression-models"
author: "Shawn Zamani"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(finalfit)
```

# Read data

```{r}
occams_best2_all_cohort <- read_csv('data/processed/chapter.2_occams_best2_all_cohort_20230119.csv') %>%
  select(-ID) %>% 
    mutate(bmi_group = case_when(
    bmi_group == "normal" ~ "0_normal",
    bmi_group == "underweight" ~ "0_normal",
    bmi_group == "overweight" ~ "2_overweight",
    bmi_group == "obese" ~ "3_obese"
  )) %>%
    mutate(duration_since_heartburn_start = case_when(
      duration_since_heartburn_start == "Never" ~ "0_Never",
      duration_since_heartburn_start == "< 5 years" ~ "1_< 5 years",
      duration_since_heartburn_start == "5-10 years" ~ "2_5-10 years",
      duration_since_heartburn_start == "> 10 years" ~ "3_> 10 years"
  )) %>% 
  mutate(gender = case_when(
    gender == 'M' ~ '0_M',
    gender == 'F'~ '1_F',
  )) %>% 
  filter(RP.SiewertClassification %in% c("Type I", "Type II", "Type II", NA))
```


# Generate regression matrices


datasets to create:

1.  BE/IM EAC , Non-BE/IM EAC             **DONE**
2.  BE/IM EAC , Unknown BE/IM EAC         **DONE** 
3.  Non-BE/IM EAC , Unknown BE/IM EAC     **DONE** 

4.  Barretts , BE/IM EAC                  **DONE**
5.  Barretts , Non-BE/IM EAC              **DONE**
6.  Barretts , Unknown BE/IM EAC          **DONE**

7.  Control , BE/IM EAC                   **DONE**
8.  Control , Non-BE/IM EAC               **DONE**
9.  Control , Unknown BE/IM EAC           **DONE**

```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE))
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "BE/IM EAC"), ordered = TRUE)) 
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 



# Barretts , BE/IM EAC
Barretts_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "BE/IM EAC"), ordered = TRUE))
# Barretts , Non-BE/IM EAC
Barretts_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Non-BE/IM EAC"), ordered = TRUE))
# Barretts , Unknown BE/IM EAC
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Unknown BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Unknown BE/IM EAC"), ordered = TRUE)) 



# Control , BE/IM EAC
Control_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "BE/IM EAC"), ordered = TRUE)) 
# Control , Non-BE/IM EAC  
Control_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "Non-BE/IM EAC"), ordered = TRUE)) 
# Control , Unknown BE/IM EAC
Control_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Unknown BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "Unknown BE/IM EAC"), ordered = TRUE))
```



I ran univariable and mutivariable models using the finalfit package - I get the same ORs/CIs using this package or the built in glm() models - just don't use the metrics in the finalfit arguement. I then use the KableExtra package to get column % of variables inclduing missing data. These rest is copy/pasting in Excel

```{r}
dependent <- "Phenotype"
independent <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin',
    'pTNM_f'
  )
independent_base <- c('age_group', 'gender')
independent_permute <-
  c("bmi_group",
    "smk_ever_smoked",
    "taken_nsaids",
    'heartburn_inferred_bin',
    'pTNM_f')
independent_permute_sensitivity <-
  c("bmi_group", 
    "smk_ever_smoked", 
    "taken_nsaids", 
    'pTNM_f')

independent_no_TNMStage <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin'
    )
independent_permute_no_TNMStage <-
  c("bmi_group",
    "smk_ever_smoked",
    "taken_nsaids",
    'heartburn_inferred_bin'
)
independent_permute_sensitivity_no_TNMStage <-
  c("bmi_group", 
    "smk_ever_smoked", 
    "taken_nsaids"
    )
```

# Run regression models

## BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
      # TNM Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[5])
    ) %>%
      fit2df(estimate_suffix = " (TNM model)")
  ) %>%
    ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model sensitivity: remove relfux)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# OR plot
# BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
    # dplyr::mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
    # dplyr::mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
# or_plot(dependent, independent,   breaks = c(0.5, 1, 5, 10, 20, 30)) 
```

## Unknown_BE_IM_EAC_vs_BE_IM_EAC


```{r}
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
        # TNM Model
  ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[5])
    ) %>%
      fit2df(estimate_suffix = " (TNM model)")
) %>% 
    ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)


# BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent, breaks = c(0.5, 1.00, 1.50, 2.00,  2.50)) 
```

## Unknown_BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
          # TNM Model
  ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute[5])
    ) %>%
      fit2df(estimate_suffix = " (TNM model)")
) %>% 
    ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
  # or_plot(dependent, independent)
```

## Barretts_vs_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent_no_TNMStage) 
```

## Barretts_vs_Non_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_Non_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%
or_plot(dependent, independent_no_TNMStage) 
```

## Barretts_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent_no_TNMStage) 
```

## Control_vs_BE_IM_EAC


```{r}
Control_vs_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

Control_vs_BE_IM_EAC_logit_model_data %>%
or_plot(dependent, independent_no_TNMStage) 
```



## Control_vs_Non_BE_IM_EAC


```{r}
Control_vs_Non_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_Non_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

## Control_vs_Unknown_BE_IM_EAC


```{r}
Control_vs_Unknown_BE_IM_EAC_logit_model_data %>%   
summary_factorlist(dependent,
                     c(independent_base, independent_no_TNMStage),
                     column = TRUE,
                     fit_id = TRUE) %>%
  # Univariable
  ff_merge(
    glmuni(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Univariable)")
  ) %>%
  # Base
  ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      independent_base
    ) %>%
      fit2df(estimate_suffix = " (Base model [age+sex])")
  ) %>%
  # BMI Model
  ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[1])
    ) %>%
      fit2df(estimate_suffix = " (BMI model)")
  ) %>%
    # Smoking Model
  ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[2])
    ) %>%
      fit2df(estimate_suffix = " (Smoking model)")
  ) %>%
    # NSAID Model
  ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[3])
    ) %>%
      fit2df(estimate_suffix = " (NSAID model)")
  ) %>%
    # Reflux Model
  ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage[4])
    ) %>%
      fit2df(estimate_suffix = " (Reflux model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent,
      c(independent_base, independent_permute_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model)")
  ) %>%
    ff_merge(
    glmmulti(
      Control_vs_Unknown_BE_IM_EAC_logit_model_data,
      dependent, 
      c(independent_base, independent_permute_sensitivity_no_TNMStage)
    ) %>%
      fit2df(estimate_suffix = " (Fully adjusted model: relfux sensitivity)")
  ) %>%
  select(-c(fit_id, index)) %>%    
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```


# Univar regression 

I ran univariable and mutivariable models using the finalfit package - I get the same ORs/CIs using this package or the built in glm() models - just don't use the metrics in the finalfit arguement. I then use the KableExtra package to get column % of variables inclduing missing data. These rest is copy/pasting in Excel

```{r}
dependent <- "Phenotype"
independent <-
  c(
# "StudySite",
"DI.ageAtDiagnosis",
"age_group", 
"DI.PatientGender",
# "Ethnicity",

"BMI_n",
"BMI_Class_f",
# "BMI_5yrs_Ago_n",
# "BMI_Class_5yrs_Ago_f",
# "BMI_Diff_n",

"Smoker_Ever",
# "smoking_CPD",
# "smoking_duration_yrs",
# "smoking_NPY",

# "EX.HeavyDrinker", 
# "EX.UnitsPerWeekInTotal",

# "EX.DurationOfRefluxSymptoms_f",
# "EX.RefluxFrequencyOfSymptoms_f",
# "EX.PatientOnAcidSuppressant",
# "EX.SymptomaticOnAcidSuppressant",
# "EX.ProtonPumpInhibitor",
# "PPI_Total_Years_n",
# "# PPI_Total_Years",
# "EX.OverTheCounterAcidSuppressants",
# "OTCAcidSupp_Total_Years_n",
# "# OTCAcidSupp_Total_Years",
# "EX.HistamineType2ReceptorAntagonist",
# "H2RA_Total_Years_n",
# "# H2RA_Total_Years",
# "ACID_SUPPRESSANT",
"heartburn_inferred_bin",

# "EX.Asprin",
# "Aspirin_Total_Years_n",
# "NSAIDs",
# "NSAIDs_Total_Years_n",
"TAKEN_NSAIDS",

# "Tumor_Length_CM_n",
# "RP.SiewertClassification" ,
# "RP.TumourDifferentiation.c", 
# "RP.Location",
# "RP.PostOpPathCombinedTumourSite",
"pTNM_f",
# "RP.PS.Tumour.Diff.c",
# "RP.Tumour.Growth.c",

# "EX.BarrettsOesophagusUndergoingSurveillance",
"Death",
"Years_Surv"
  )
```

# Run regression models

```{r}
occams_best2_all_cohort_univar <- read_csv('data/processed/chapter.2_cleaned-occams-data_20230119.csv')
```

## BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data <- 
  
  occams_best2_all_cohort_univar %>% 
  filter(!is.na(age_group)) %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance =='yes') %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) %>% 
  
  mutate(
  EX.RefluxFrequencyOfSymptoms_f = case_when(
    EX.RefluxFrequencyOfSymptoms_f == 'never' ~ '0_never',
    EX.RefluxFrequencyOfSymptoms_f == 'sometimes' ~ '1_sometimes',
    EX.RefluxFrequencyOfSymptoms_f == 'often' ~ '2_often',
    EX.RefluxFrequencyOfSymptoms_f == 'daily' ~ '3_daily',
    EX.RefluxFrequencyOfSymptoms_f == 'unknown' ~ '4_unknown'
  ),
  
  EX.DurationOfRefluxSymptoms_f = case_when(
    EX.DurationOfRefluxSymptoms_f == "never" ~ "0_Never",
    EX.DurationOfRefluxSymptoms_f == "< 5 years" ~ "1_< 5 years",
    EX.DurationOfRefluxSymptoms_f == "5-10 years" ~ "2_5-10 years",
    EX.DurationOfRefluxSymptoms_f == "> 10 years" ~ "3_> 10 years",
    EX.DurationOfRefluxSymptoms_f == 'unknown' ~ '4_unknown'
  )) %>% 
    
  mutate(
    
  RP.TumourDifferentiation.c = case_when(
    RP.TumourDifferentiation.c == 'moderate' ~ '0_moderate',
    RP.TumourDifferentiation.c == 'poor' ~ '1_poor',
    RP.TumourDifferentiation.c == 'well' ~ '2_well',
  ),
  
  RP.Location = case_when(
    RP.Location == 'goj' ~ '0_goj',
    RP.Location == 'oesophageal' ~ '1_oesophageal',
    RP.Location == 'gastric' ~ '2_gastric',
  ),
  
    RP.Tumour.Growth.c = case_when(
    RP.Tumour.Growth.c == 'no change' ~ '0_no change',
    RP.Tumour.Growth.c == 'shrink' ~ '1_shrink',
    RP.Tumour.Growth.c == 'grow' ~ '2_grow',
  )) %>% 
  mutate(Death = case_when(
    Death == 0 ~ "N", 
    Death == 1 ~ "Y", 
    TRUE ~ "Unknown")) %>% 

  
  mutate(across(where(~is_character(.x)), ~ as.character(.x))) %>% 
  mutate(across(where(~is_character(.x)), ~ replace_na(.x, "Z_Missing"))) %>% 
  mutate(across(where(~is_character(.x)), ~ case_when(.x == 'ever' ~ 'Y', .x == 'never' ~ 'N', TRUE ~ .x)))
  


BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
  finalfit(
    dependent,
    independent,
    keep_models = F,
    column = T,
    explanatory_multi = 'age_group'
  )  %>%    kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

```
### T stage trend

```{r}
trenddata <- BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data
table(trenddata$pTNM_f, trenddata$Phenotype)
     
       # no yes
  # I    87 294
  # II  200 279
  # III 447 481
  # IV   26  26

CochranArmitageTest(table(trenddata$pTNM_f, trenddata$Phenotype))
```

# MLR
I get the same results when using MLR vs logistic regression alone. 
```{r}
require(nnet)

ml <- occams_best2_all_cohort %>% 
  filter(Phenotype!='Control') %>% 
  mutate(Phenotype=as.factor(Phenotype))
ml$Phenotype2 <- relevel(ml$Phenotype, ref = 'Barretts')

test <- multinom(Phenotype2 ~ smk_ever_smoked + age_group, data = ml)
summary(test)
z <- summary(test)$coefficients/summary(test)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
```