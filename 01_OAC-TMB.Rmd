---
title: "00_OAC-TMB"
author: "Shawn Zamani"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# packages ----------------------------------------------------------------
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(rstatix)
library(kableExtra)
```

# read and prepare data
```{r , include=FALSE}
# process data file -------------------------------------------------------
# 710 cohort
oac_total_snv_indel_TMB_0 <- vroom::vroom('data/original/wgs/OAC.710_TMB_counts.txt', col_names = F) %>%
  rename(
    DNA_ID = X1,
    snv_count = X2,
    indel_count = X3,
    ref_length = X4,
  ) %>%
  mutate(
    total_count = snv_count + indel_count,
    total_count_per_mb = ((total_count * (10 ^ 6)) / ref_length),
    temp_total_count_per_mb = ((total_count) / (ref_length / (10 ^ 6))),
    log2_total_count_per_mb = round(log2(total_count_per_mb + 1), digits = 2),
    log10_total_count_per_mb = round(log10(total_count_per_mb + 1), digits = 2),
    log10_total_count = round(log10(total_count + 1), digits = 2)
  ) %>%
  mutate(
    abnormal_DNA_ID = str_extract(DNA_ID, '.+_vs_'),
    abnormal_DNA_ID = str_replace(abnormal_DNA_ID, '_vs_', ''),
    normal_DNA_ID = str_extract(DNA_ID, '_vs_.+'),
    normal_DNA_ID = str_replace(normal_DNA_ID, '_vs_', ''),
  ) %>%
  relocate(c(abnormal_DNA_ID, normal_DNA_ID), .after = DNA_ID) %>%
  relocate(total_count, .after = indel_count) %>% 
  select(-temp_total_count_per_mb)

OAC_710_cohort <-
  vroom::vroom('data/original/wgs/case_spec_dna_occams_oac_normal.710.csv', col_names = FALSE) %>%
  transmute(
    ID = str_replace(X1, 'OC/', 'OCCAMS/'),
    spec_oac = X2,
    dna_oac = X3,
    dna_normal = X4
  ) %>%
  select(-spec_oac) %>%
  rename(abnormal_DNA_ID = dna_oac,
         normal_DNA_ID = dna_normal) %>%
  unite(col = DNA_ID, abnormal_DNA_ID, normal_DNA_ID, remove = FALSE, sep = '_vs_')

oac_total_snv_indel_TMB <-
  inner_join(
    oac_total_snv_indel_TMB_0,
    OAC_710_cohort,
    by = c('DNA_ID', 'abnormal_DNA_ID', 'normal_DNA_ID')
  ) %>% 
  relocate(.before = 'DNA_ID', ID)

write_csv(oac_total_snv_indel_TMB, 'data/processed/wgs_processed/oac_total_snv_indel_TMB_20230401.csv')

write_csv(oac_total_snv_indel_TMB, 'data/processed/paper/oac_total_snv_indel_TMB_20240507.csv')


# GEL cohort
# NB: the GEL file names use the normal_abnormal convention rather than the abnormal_vs_normal used in our convention.

# read in the TMB data that i processed on the cluster
gel_bo_oac_snv_indel_purity <-
  vroom::vroom('data/original/wgs/gel_oac_tmb_sz_20230401.csv', col_names = F) %>%
  rename(
    DNA_ID = X1,
    snv_count = X2,
    indel_count = X3,
    estimated_purity = X4,
  ) %>%
  mutate(
    normal_DNA_ID = str_extract(DNA_ID, '.+_L'),
    normal_DNA_ID = str_replace(normal_DNA_ID, '_L', ''),
    abnormal_DNA_ID = str_extract(DNA_ID, '[:digit:]_.+'),
    abnormal_DNA_ID = str_replace(abnormal_DNA_ID, '[:digit:]_', ''),
    ref_length = 3137454505
  ) %>% 
  relocate(c(abnormal_DNA_ID, normal_DNA_ID), .after = DNA_ID)

oac_gel_cohort <-
  vroom::vroom('data/original/wgs/gel_submission_metadata_ginny_BO_OAC.csv.csv', col_names = TRUE) %>% 
  rename(abnormal_DNA_ID = abnormal_ID) %>% 
  filter(grepl('OCCAMS', ID))
  
oac_gel_total_snv_indel_TMB <-
  inner_join(oac_gel_cohort,
             gel_bo_oac_snv_indel_purity,
             "abnormal_DNA_ID") %>%
  select(ID, snv_count, indel_count, estimated_purity, ref_length) %>%
  group_by(ID) %>%
  mutate(
    snv_count = mean(snv_count, na.rm = FALSE),
    indel_count = mean(indel_count, na.rm = FALSE),
    total_count = snv_count + indel_count,
    total_count_per_mb = ((total_count * (10 ^ 6)) / ref_length),
    # temp_total_count_per_mb = ((total_count) / (ref_length / (10 ^ 6))),
    log2_total_count_per_mb = round(log2(total_count_per_mb + 1), digits = 2),
    log10_total_count_per_mb = round(log10(total_count_per_mb + 1), digits = 2),
    log10_total_count = round(log10(total_count + 1), digits = 2),
    estimated_purity = round(mean(estimated_purity, na.rm = FALSE) / 100, digits = 2)) %>%
    distinct(ID, .keep_all = TRUE)


# write_csv(oac_gel_total_snv_indel_TMB, 'data/processed/wgs_processed/oac_gel_total_snv_indel_TMB_20230401.csv')

```

```{r}
oac_all_cohort_tmb <- bind_rows(oac_total_snv_indel_TMB, oac_gel_total_snv_indel_TMB)
# write_csv(oac_all_cohort_tmb, 'data/processed/wgs_processed/oac_all_cohort_tmb_20230404.csv')

occams_wgs_thesis_cohort <- read_csv('data/processed/wgs_processed/occams_thesis_wgs_cohort_20230402.csv')


oac_tmb_epi <- inner_join(occams_wgs_thesis_cohort,
            oac_all_cohort_tmb,
           by = "ID")
# 
# write_csv(oac_tmb_epi, 'data/processed/wgs_processed/oac_all_cohort_tmb_epi_20230401.csv')

oac_tmb_epi <-
  read_csv('data/processed/wgs_processed/oac_all_cohort_tmb_epi_20230401.csv') %>%
  mutate(
    BMI_Class_f = case_when(
      BMI_Class_f == "normal" ~ "0_normal",
      BMI_Class_f == "underweight" ~ "0_normal",
      BMI_Class_f == "overweight" ~ "2_overweight",
      BMI_Class_f == "obese" ~ "3_obese"
    )
  ) %>%
  mutate(across(.cols = c(10:14), ~ as.character(.x))) %>%
  mutate(across(.cols = c(10:14), ~ replace_na(.x, "Missing"))) %>%
  mutate(across(.cols = c(31:36), ~ as.character(.x))) %>%
  mutate(across(.cols = c(31:36), ~ replace_na(.x, "Missing"))) %>% 
  mutate(across(.cols = c(39:48), ~ as.character(.x))) %>%
  mutate(across(.cols = c(39:48), ~ replace_na(.x, "Missing")))

```

# Mut count overall

1) REPORT overall median TMB
2) REPORT by phenotype next

```{r}
tmb_median <-  oac_tmb_epi %>% 
  filter(total_count<270000) %>% 
  group_by(Phenotype) %>% 
  mutate(tmb_median = median(total_count))

oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(!is.na(age_group)) %>% 
  group_by(Phenotype) %>%
  summarise(
    tmb_median = median(total_count),
    iqr = quantile(total_count),
    # muts_mb_median = median(total_count_per_mb),
    # iqr = quantile(total_count_per_mb)
  ) %>% 
    kable() %>% 
  kable_styling(full_width = FALSE)

# IND share
oac_tmb_epi %>% 
  filter(total_count<270000) %>% 
  mutate(perc_indel = indel_count/total_count) %>% 
  group_by(Phenotype) %>%
  # kruskal_test(perc_indel ~ Phenotype)
  summarise(
            med_perc_indel = mean(perc_indel)) 

wilcox_tmb <- tmb_median %>% 
  # filter(Phenotype!="Unknown BE/IM EAC")
  filter(Phenotype!="BE/IM EAC")
  # filter(Phenotype!="Non-BE/IM EAC")
  wilcox.test(wilcox_tmb$total_count~wilcox_tmb$Phenotype)

# New facet label names for phenotype variable
UK_phenotype_labs <- c(
  "BE/IM EAC" = "BO+ve OAC",
  "Non-BE/IM EAC" = "BO-ve OAC",
  "Unknown BE/IM EAC" = "BO(?) OAC"
)


oac_tmb_epi %>% 
  filter(total_count<270000) %>% 
  select(ID, Phenotype, SNV = snv_count, IND =indel_count) %>% 
  reshape2::melt() %>% 
ggplot(aes(x = reorder(ID, -value), y = value)) +
  geom_col(aes(fill = variable), width = 4) +
  geom_errorbar(data = tmb_median, mapping = aes(ID, ymax = tmb_median, ymin = tmb_median),
               linewidth=0.5, linetype = "longdash", inherit.aes = F, width = 1) + 
  facet_grid(cols = vars(Phenotype), scales = 'free', labeller = as_labeller(UK_phenotype_labs)) +
  ylab('Total mutations') +
  theme_bw()+
  theme(
    text = element_text(size = 12),
    legend.position = 'top',
    # legend.title = element_blank(),
    panel.grid =element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  scale_fill_brewer(palette = 'Dark2') +
  guides(fill=guide_legend(title="Mutation type"))+
  coord_cartesian(ylim = c(0, 2.75*10^5)) 


```

# Mut/Mb


1) REPORT overall Muts/Mb
2) REPORT by phenotype next
## By phenotype
```{r}
# Mut/Mb overall and by phenotype
oac_tmb_epi %>% 
  filter(total_count<270000) %>% 
  group_by(Phenotype) %>%
  summarise(MutsPerMb_median = median(total_count_per_mb),
            iqr = quantile(total_count_per_mb)) %>% 
      kable() %>% 
  kable_styling(full_width = FALSE)


# New facet label names for phenotype variable
UK_phenotype_labs <- c(
  "BE/IM EAC" = "BO+ve OAC",
  "Non-BE/IM EAC" = "BO-ve OAC",
  "Unknown BE/IM EAC" = "BO(?) OAC"
)
# color scheme of the phenotypes
# Phenotype_colors <-  c("#e41a1c", "#377eb8", "#CC0099")
# specify comparisons
my_comparisons <- list( c("BE/IM EAC", "Non-BE/IM EAC"), c("BE/IM EAC", "Unknown BE/IM EAC"), c("Non-BE/IM EAC", "Unknown BE/IM EAC") )

oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  # filter(Phenotype == "BE/IM EAC") %>%
  ggplot(aes(x = Phenotype, y = total_count_per_mb), labeller = as_labeller(UK_phenotype_labs)) +
  # facet_grid(cols = vars(age_group)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+ 
  theme(    
    text = element_text(size = 14),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  coord_cartesian(ylim = c(0, 60)) +
  stat_compare_means(comparisons = my_comparisons,  label.y = c(40, 45, 52), size = 3) +# Add pairwise comparisons p-value
  stat_compare_means(label.y = 60,label.x = 0.8, size = 3)
```


## Age group effect
```{r}
# specify comparisons
my_age_comparisons <- list( c("< 60 years old", "60 - 69 years old"), c("< 60 years old", "70+ years old"), c("60 - 69 years old", "70+ years old") )
### age overall
oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(!is.na(age_group)) %>% 
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
    )) %>%
  # filter(Phenotype == "BE/IM EAC") %>%
  ggplot(aes(x = age_group, y = total_count_per_mb), labeller = as_labeller(UK_phenotype_labs)) +
  facet_grid(cols = vars(Phenotype)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+
  theme(
    text = element_text(size = 14),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  coord_cartesian(ylim = c(0, 40)) +
  stat_compare_means(comparisons = my_age_comparisons,  label.y = c(25, 30, 35), size = 3) +# Add pairwise comparisons p-value
  stat_compare_means(label.y = 25.5, size = 3)




pvalues <- c(0.93, .28, .28, .0052, .37, .00046, .11, .68, .049)
p.adjust(pvalues,method="BH")
# p val correction
stat.test <- oac_tmb_epi %>%
    filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
    )) %>% 
  group_by(age_group) %>%
  wilcox_test(total_count_per_mb ~ Phenotype) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>% 
  add_xy_position(x = "Phenotype") %>% 
  mutate(p.adj = round(p.adj, digits = 3))

oac_tmb_epi %>%
    filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
    )) %>% 
  ggplot(aes(x = Phenotype, y = total_count_per_mb)) +
  facet_grid(cols = vars(age_group)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+ 
  theme(    
    text = element_text(size = 14),
    axis.text.x = element_text(size = 9, angle = 25, vjust = 1, hjust=1),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  stat_pvalue_manual(stat.test, label = "p.adj", bracket.nudge.y = -50) +
  coord_cartesian(ylim = c(0, 70))


  # stat_compare_means(comparisons = my_comparisons,  label.y = c(25, 30, 35), size = 3) # Add pairwise comparisons p-value
  # stat_compare_means(label.y = 25.5, size = 3)
# axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


# Get median
oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(!is.na(age_group)) %>%
  filter(age_group == '60 - 69 years old') %>%
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
  )) %>%
  group_by(Phenotype, age_group) %>% 
  summarise(tmb_median = median(total_count_per_mb),
            iqr = quantile(total_count_per_mb)) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE)

################ CMH Test #################

cmh_test <- oac_tmb_epi %>%
  filter(total_count < 270000) %>%
      mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
    )) %>% 
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
  )) %>%
  filter(Phenotype != "Unknown BE/IM EAC") %>%
  # filter(Phenotype != "BE/IM EAC") %>%
  mutate(
    Phenotype = case_when(
      Phenotype == 'Non-BE/IM EAC' ~ '0_BO-ve',
      Phenotype == 'BE/IM EAC' ~ '1_BO+ve',
      Phenotype == 'Unknown BE/IM EAC' ~ '2_BO(?)'
    )
  ) %>%
  select(Phenotype, TMB_median, age_group, Smoker_Ever, pTNM_f) %>%
  as.data.frame()


# unadjusted
# OR          lower   upper     p val
# 0.6182385 0.4200026 0.910039 0.01451339
table(cmh_test$TMB_median, cmh_test$Phenotype)
epitools::epitab(cmh_test$TMB_median, cmh_test$Phenotype,pvalue = 'chi2')

# controlled for age_group
# common OR      lower   upper     p val
# 0.619128  0.4207027 0.9111412 0.01927# OR          lower   upper     p val
# 0.6182385 0.4200026 0.910039 0.01451339

table(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$age_group)
mantelhaen.test(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$age_group)

# controlled for Smoker_Ever
# common OR      lower   upper     p val
# 0.6003573  0.4040379 0.8920669 0.01528
table(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$Smoker_Ever)
mantelhaen.test(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$Smoker_Ever)

# controlled for pTNM_f
# common OR      lower   upper     p val
# 0.6694013  0.4490552 0.9978685 0.06133
table(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$pTNM_f)
mantelhaen.test(cmh_test$TMB_median, cmh_test$Phenotype, cmh_test$pTNM_f)

################ Logistic Regression #################

wilcox_tmb <- oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(!is.na(age_group)) %>%
  filter(Phenotype != "Unknown BE/IM EAC") %>%
  # filter(Phenotype!="BE/IM EAC") %>%
  # filter(Phenotype!="Non-BE/IM EAC") %>%
  mutate(Phenotype = factor(Phenotype, levels = c("Non-BE/IM EAC", "BE/IM EAC"), ordered = T)) %>%
    # mutate(Phenotype = factor(Phenotype, levels = c("Non-BE/IM EAC", "Unknown BE/IM EAC"), ordered = T)) %>%
  mutate(Smoker_Ever = case_when(
    Smoker_Ever == 'ever' ~ 'Y',
    Smoker_Ever == 'never' ~ 'N',
    Smoker_Ever == 'Missing' ~ 'z_Missing',
  )) %>% 
  mutate(Phenotype = case_when(
    Phenotype=='Non-BE/IM EAC' ~ '0_BO-ve',
    Phenotype=='BE/IM EAC' ~ '1_BO+ve',
    Phenotype=='Unknown BE/IM EAC' ~ '2_BO(?)'
    )) %>% 
    mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
    )) %>%
  mutate(
    dummy_1 = if_else(Phenotype=='1_BO+ve', 1, 0),
    dummy_2 = if_else(Phenotype=='2_BO(?)', 1, 0),
  ) %>% 
  mutate(Phenotype = factor(Phenotype, ordered = T))


lm0 <- lm(log10_total_count_per_mb~Phenotype, data = wilcox_tmb)
summary(lm0)



lm(log10_total_count_per_mb~Phenotype+DI.ageAtDiagnosis+Smoker_Ever+pTNM_f, data = wilcox_tmb)
  
wilcox.test(wilcox_tmb$log10_total_count_per_mb~wilcox_tmb$Phenotype)

# unadjusted
logit0 <- glm(Phenotype~log10_total_count_per_mb, data = wilcox_tmb, family = 'binomial')
gtsummary::tbl_regression(logit0, exponentiate = TRUE)

# controlled for age 
logit1 <- glm(Phenotype~log10_total_count_per_mb + DI.ageAtDiagnosis, data = wilcox_tmb, family = 'binomial')
gtsummary::tbl_regression(logit1, exponentiate = TRUE)

# controlled for Smoker_Ever 
logit2 <- glm(Phenotype~log10_total_count_per_mb + Smoker_Ever, data = wilcox_tmb, family = 'binomial')
gtsummary::tbl_regression(logit2, exponentiate = TRUE)

# controlled for pTNM_f 
logit3 <- glm(Phenotype~log10_total_count_per_mb + pTNM_f, data = wilcox_tmb, family = 'binomial')
gtsummary::tbl_regression(logit3, exponentiate = TRUE)

# controlled for all 3 
logit4 <- glm(Phenotype~log10_total_count_per_mb + DI.ageAtDiagnosis+ Smoker_Ever + pTNM_f, data = wilcox_tmb, family = 'binomial')
gtsummary::tbl_regression(logit4, exponentiate = TRUE)

# UNIVARIABLE
independent <- c(
  'log10_total_count_per_mb',
  'DI.ageAtDiagnosis', 
  # 'DI.PatientGender',
  # 'BMI_Class_f', 
  'Smoker_Ever',
  # 'TAKEN_NSAIDS',
  # 'heartburn_inferred_bin',
  'pTNM_f'
)
dependent <- 'Phenotype'

wilcox_tmb %>% 
  finalfit::finalfit(dependent, independent,column = T,
) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = FALSE)
```
## Smoking effect
```{r}
# specify comparisons
my_smoking_comparisons <- list( c("ever", "never"), c("ever", "unknown"), c("never", "unknown") )


# p val correction
stat.test <- oac_tmb_epi %>%
    filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
    mutate(Smoker_Ever = factor(case_when(
    Smoker_Ever == 'ever' ~ 'Ever-smoker',
    Smoker_Ever == 'never' ~ 'Never-smoker',
    TRUE ~ Smoker_Ever
  ))) %>% 
  group_by(Smoker_Ever) %>%
  wilcox_test(total_count_per_mb ~ Phenotype) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>% 
  add_xy_position(x = "Phenotype") %>% 
  mutate(p.adj = round(p.adj, digits = 3))

oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(!is.na(age_group)) %>%
  mutate(Smoker_Ever = factor(case_when(
    Smoker_Ever == 'ever' ~ 'Ever-smoker',
    Smoker_Ever == 'never' ~ 'Never-smoker',
    TRUE ~ Smoker_Ever
  ),levels = c('Ever-smoker', 'Never-smoker', 'Missing'))) %>%  
  ggplot(aes(x = Smoker_Ever, y = total_count_per_mb), labeller = as_labeller(UK_phenotype_labs)) +
  facet_grid(cols = vars(Phenotype)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+
  theme(
    text = element_text(size = 14),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  coord_cartesian(ylim = c(0, 40)) +
  stat_compare_means(comparisons = my_smoking_comparisons,  label.y = c(25, 30, 35), size = 3) # Add pairwise comparisons p-value
  # stat_compare_means(label.y = 25.5, size = 3)


# p val correction
stat.test <- oac_tmb_epi %>%
    filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
    mutate(Smoker_Ever = factor(case_when(
    Smoker_Ever == 'ever' ~ 'Ever-smoker',
    Smoker_Ever == 'never' ~ 'Never-smoker',
    TRUE ~ Smoker_Ever
  ))) %>% 
  group_by(Smoker_Ever) %>%
  wilcox_test(total_count_per_mb ~ Phenotype) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>% 
  add_xy_position(x = "Phenotype") %>% 
  mutate(p.adj = round(p.adj, digits = 3))


oac_tmb_epi %>%
  filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
  mutate(Smoker_Ever = factor(case_when(
    Smoker_Ever == 'ever' ~ 'Ever-smoker',
    Smoker_Ever == 'never' ~ 'Never-smoker',
    TRUE ~ Smoker_Ever
  ),levels = c('Ever-smoker', 'Never-smoker', 'Missing'))) %>% 
  ggplot(aes(x = Phenotype, y = total_count_per_mb), labeller = as_labeller(UK_phenotype_labs)) +
  facet_grid(cols = vars(Smoker_Ever)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+ 
  theme(    
    text = element_text(size = 14),
    axis.text.x = element_text(size = 9, angle = 25, vjust = 1, hjust=1),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  stat_pvalue_manual(stat.test, label = "p.adj", y.position = 35, step.increase = .055, bracket.nudge.y = -15, tip.length = .02)  +
  coord_cartesian(ylim = c(0, 60))


# Get median
oac_tmb_epi %>%
  filter(total_count < 270000) %>%
  filter(Smoker_Ever == 'never') %>%
  mutate(Smoker_Ever = factor(case_when(
    Smoker_Ever == 'ever' ~ 'Ever-smoker',
    Smoker_Ever == 'never' ~ 'Never-smoker',
    TRUE ~ Smoker_Ever
  ),levels = c('Ever-smoker', 'Never-smoker', 'Missing'))) %>% 
  group_by(Phenotype, Smoker_Ever) %>% 
  summarise(tmb_median = median(total_count_per_mb),
            iqr = quantile(total_count_per_mb)) 
```
## TNM

```{r}
oac_tmb_epi %>%
  filter(total_count < 270000) %>%
      filter(!is.na(age_group)) %>%
      mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
    )) %>% 
  mutate(age_group = case_when(
    age_group %in% c("< 50 years old", "50 - 59 years old") ~ "< 60 years old",
    TRUE ~ age_group
    )) %>%
  ggplot(aes(x = pTNM_f, y = total_count_per_mb)) +
  facet_grid(cols = vars(Phenotype)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw()+
  theme(
    text = element_text(size = 14),
    axis.title.x = element_blank()) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  coord_cartesian(ylim = c(0, 40)) +
  stat_compare_means(comparisons = my_comparisons,  label.y = c(25, 30, 35), size = 3) +# Add pairwise comparisons p-value
  stat_compare_means(label.y = 25.5, size = 3)


# p val correction
stat.test <- oac_tmb_epi %>%
    filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
    mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
    )) %>% 
  group_by(pTNM_f) %>%
  wilcox_test(total_count_per_mb ~ Phenotype) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>% 
  add_xy_position(x = "Phenotype") %>% 
  mutate(p.adj = round(p.adj, digits = 3))


oac_tmb_epi %>%
  filter(total_count < 270000) %>%
    filter(!is.na(age_group)) %>%
  mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
  )) %>%
  ggplot(aes(x = Phenotype, y = total_count_per_mb)) +
  facet_grid(cols = vars(pTNM_f)) +
  geom_boxplot(width = .5) +
  geom_jitter(width = .1,
              size = .5,
              alpha = 0.5) +
  ylab('Mutations/Mb') +
  theme_bw() +
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(
      size = 9,
      angle = 25,
      vjust = 1,
      hjust = 1
    ),
    axis.title.x = element_blank()
  ) +
  scale_x_discrete(labels = UK_phenotype_labs) +
  stat_pvalue_manual(
    stat.test,
    label = "p.adj",
    y.position = 35,
    step.increase = .055,
    bracket.nudge.y = -15,
    tip.length = .02
  )  +
  coord_cartesian(ylim = c(0, 60))


# Get median
oac_tmb_epi %>%
  filter(total_count < 270000) %>%
      mutate(pTNM_f = case_when(
    pTNM_f %in% c("I", "II") ~ "I/II",
    pTNM_f %in% c("III", "IV") ~ "III/IV",
    TRUE ~ pTNM_f
    )) %>% 
  # filter(pTNM_f == 'I/II') %>%
  filter(pTNM_f == 'III/IV') %>%
  group_by(Phenotype, pTNM_f) %>% 
  summarise(tmb_median = median(total_count_per_mb),
            iqr = quantile(total_count_per_mb)) 
```

# Factors that can affect mutational load
## Cellularity and mutations

Pull in the per sample ploidy data from SKill's work and do a bivariate plot of TMB ~ cellularity

```{r}
oac_tmb_ploidy <- left_join(oac_tmb_epi,
           read_tsv('data/original/wgs/per_sample_ploidy.txt')  %>% rename(DNA_ID = Sample),
           by = 'DNA_ID'
           ) %>% 
  mutate(x = coalesce(aberrant.cell, estimated_purity)) %>% 
  select(
    Phenotype,
    x, 
    estimated_purity,
    aberrant.cell,
    total_count,
    log10_total_count,
    DI.ageAtDiagnosis,
    smoking_NPY,
    smoking_duration_yrs
  )

 oac_tmb_ploidy %>%
  filter(total_count < 270000) %>%
  ggscatter(
    x = 'x',
    # x = 'estimated_purity',
    # x = 'DI.ageAtDiagnosis',
    # x = 'smoking_duration_yrs',
    # x = 'smoking_NPY',
    y = 'total_count',
    color = 'Phenotype',
    add = "reg.line",
    conf.int = TRUE,
    show.legend = FALSE,
    palette =  c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  # stat_cor(method = "pearson", show.legend = FALSE, label.y = c(300000)) +
  # facet_grid(cols = vars(Phenotype)) 
  stat_cor(aes(color = Phenotype), method = "pearson", show.legend = FALSE) +
  scale_color_manual(
    breaks = c("BE/IM EAC", "Non-BE/IM EAC", "Unknown BE/IM EAC"),
    labels = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
    values = c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  ylab('Total mutations') +
  xlab('Estimated cancerous cell fraction') +
  theme_bw() +
  theme(
    legend.position = c(0.87, 1), 
    legend.direction = "vertical") 



```


## Age and mutations
```{r}
oac_tmb_ploidy %>%
  filter(total_count < 270000) %>%
  ggscatter(
    # x = 'aberrant.cell',
    x = 'DI.ageAtDiagnosis',
    # x = 'smoking_duration_yrs',
    # x = 'smoking_NPY',
    y = 'total_count',
    color = 'Phenotype',
    add = "reg.line",
    conf.int = TRUE,
    show.legend = FALSE,
    palette =  c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  # stat_cor(method = "pearson", show.legend = FALSE, label.y = c(300000)) +
  # facet_grid(cols = vars(Phenotype)) 
  stat_cor(aes(color = Phenotype), method = "pearson", show.legend = FALSE) +
  scale_color_manual(
    breaks = c("BE/IM EAC", "Non-BE/IM EAC", "Unknown BE/IM EAC"),
    labels = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
    values = c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  ylab('Total mutations') +
  xlab('Age at diagnosis') +
  theme_bw() +
  theme(
    legend.position = 'none')

```
## Duration of smoking and mutations
```{r}
oac_tmb_ploidy %>%
  filter(total_count < 270000) %>%
  ggscatter(
    # x = 'aberrant.cell',
    # x = 'DI.ageAtDiagnosis',
    x = 'smoking_duration_yrs',
    # x = 'smoking_NPY',
    y = 'total_count',
    color = 'Phenotype',
    add = "reg.line",
    conf.int = TRUE,
    show.legend = FALSE,
    palette =  c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  # stat_cor(method = "pearson", show.legend = FALSE, label.y = c(300000)) +
  # facet_grid(cols = vars(Phenotype)) 
  stat_cor(aes(color = Phenotype), method = "pearson", show.legend = FALSE) +
  scale_color_manual(
    breaks = c("BE/IM EAC", "Non-BE/IM EAC", "Unknown BE/IM EAC"),
    labels = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
    values = c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  ylab('Total mutations') +
  xlab('Duration of smoking (years)') +
  theme_bw() +
  theme(
    legend.position = 'none')

```

## Pack-Years of smoking and mutations
```{r}
oac_tmb_ploidy %>%
  filter(total_count < 270000) %>%
  ggscatter(
    # x = 'aberrant.cell',
    # x = 'DI.ageAtDiagnosis',
    # x = 'smoking_duration_yrs',
    x = 'smoking_NPY',
    y = 'total_count',
    color = 'Phenotype',
    add = "reg.line",
    conf.int = TRUE,
    show.legend = FALSE,
    palette =  c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  # stat_cor(method = "pearson", show.legend = FALSE, label.y = c(300000)) +
  # facet_grid(cols = vars(Phenotype)) 
  stat_cor(aes(color = Phenotype), method = "pearson", show.legend = FALSE) +
  scale_color_manual(
    breaks = c("BE/IM EAC", "Non-BE/IM EAC", "Unknown BE/IM EAC"),
    labels = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
    values = c("#e41a1c", "#377eb8", "#CC0099")
  ) +
  ylab('Total mutations') +
  xlab('Pack-Years') +
  theme_bw() +
  theme(
    text = element_text(size = 12),
    legend.position = 'none')

```
