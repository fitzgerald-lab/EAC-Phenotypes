---
title: "03_cohort-sensitivity-analyses"
author: "Shawn Zamani"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(finalfit)
```

# Purpose

1.  ** run complete cases analysis**

2.  ** run imputed data analysis**

3.  ** run surveillance analysis**




# 1. Effect of surveillance

## 1.1 Read data

```{r}
occams_best2_all_cohort <- read_csv('data/processed/chapter.2_occams_best2_all_cohort_filtered_cohort-exclude_bo_surveillance_20230213.csv') %>% 
  select(-ID) %>% 
    mutate(bmi_group = case_when(
    bmi_group == "normal" ~ "0_normal",
    bmi_group == "underweight" ~ "0_normal",
    bmi_group == "overweight" ~ "2_overweight",
    bmi_group == "obese" ~ "3_obese"
  )) %>%
    mutate(duration_since_heartburn_start = case_when(
      duration_since_heartburn_start == "Never" ~ "0_Never",
      duration_since_heartburn_start == "< 5 years" ~ "1_< 5 years",
      duration_since_heartburn_start == "5-10 years" ~ "2_5-10 years",
      duration_since_heartburn_start == "> 10 years" ~ "3_> 10 years"))
```

## 1.2 Generate regression matrices

datasets to create:

1.  BE/IM EAC , Non-BE/IM EAC **DONE**

2.  BE/IM EAC , Unknown BE/IM EAC **DONE**

3.  Non-BE/IM EAC , Unknown BE/IM EAC **DONE**

4.  Barretts , BE/IM EAC **DONE**

5.  Barretts , Non-BE/IM EAC **DONE**

6.  Barretts , Unknown BE/IM EAC **DONE**

7.  Control , BE/IM EAC **DONE**

8.  Control , Non-BE/IM EAC **DONE**

9.  Control , Unknown BE/IM EAC **DONE**

```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "BE/IM EAC"), ordered = TRUE)) 
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 



# Barretts , BE/IM EAC
Barretts_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "BE/IM EAC"), ordered = TRUE))
# Barretts , Non-BE/IM EAC
Barretts_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Non-BE/IM EAC"), ordered = TRUE))
# Barretts , Unknown BE/IM EAC
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Unknown BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Unknown BE/IM EAC"), ordered = TRUE)) 



# Control , BE/IM EAC
Control_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "BE/IM EAC"), ordered = TRUE)) 
# Control , Non-BE/IM EAC  
Control_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "Non-BE/IM EAC"), ordered = TRUE)) 
# Control , Unknown BE/IM EAC
Control_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Unknown BE/IM EAC")) %>%
  mutate(across(.cols = c(2:15), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(2:15), ~ replace_na(.x, "z_missing"))) %>% 
  select(-c(pTStage_four_f, pTNM_f, RP.SiewertClassification)) %>% 
  mutate(Phenotype = factor(Phenotype, c("Control", "Unknown BE/IM EAC"), ordered = TRUE))
```

I ran univariable and mutivariable models using the finalfit package - I get the same ORs/CIs using this package or the built in glm() models - just don't use the metrics in the finalfit arguement. I then use the KableExtra package to get column % of variables including missing data. These rest is copy/pasting in Excel

```{r}
dependent <- "Phenotype"
independent <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin',
    'pTNM_f'
  )
independent_no_TNMStage <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin'
    )

```

## 1.3 Surveillance sensitivity analysis

This sen analysis is for excluding surveillance cases

### BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
or_plot(dependent, independent,   breaks = c(0.5, 1, 5, 10, 20, 30)) 
```

### Unknown_BE_IM_EAC_vs_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
or_plot(dependent, independent, breaks = c(0.5, 1.00, 1.50, 2.00,  2.50)) 
```

### Unknown_BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
  # or_plot(dependent, independent)
```

### Barretts_vs_BE_IM_EAC

```{r}
Barretts_vs_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Barretts_vs_Non_BE_IM_EAC

```{r}
Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%   
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Barretts_vs_Unknown_BE_IM_EAC

```{r}
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Control_vs_BE_IM_EAC

```{r}
Control_vs_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Control_vs_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Control_vs_Non_BE_IM_EAC

```{r}
Control_vs_Non_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

### Control_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
Control_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

# 2. Complete case analysis

## 2.1 Read data

original data that includes all OAC cases whether or not they were under BO Surveillance

```{r}
occams_best2_all_cohort <- read_csv('data/processed/chapter.2_occams_best2_all_cohort_20230119.csv') %>%
  select(-c(ID, age, ethnicity, bmi, RP.SiewertClassification, acid_suppressant, duration_since_heartburn_start, pTStage_four_f)) %>% 
  mutate(pTNM_f = case_when(
    Phenotype %in% c('Barretts', 'Control') ~ 'not applicable',
    TRUE ~ pTNM_f
  )) %>% 
    mutate(bmi_group = case_when(
    bmi_group == "normal" ~ "0_normal",
    bmi_group == "underweight" ~ "0_normal",
    bmi_group == "overweight" ~ "2_overweight",
    bmi_group == "obese" ~ "3_obese"
  ))
```

sensitivity analysis dataset where I have removed all OAC cases that were under surveillance (215 total, with 146 as BO+ve OAC and 21 as BO-ve OAC and the rest unknown)

```{r}
# occams_best2_all_cohort_exclude_surveillance <- read_csv('data/processed/chapter.2_occams_best2_all_cohort_filtered_cohort-exclude_bo_surveillance_20221110.csv') %>%
#   select(-ID) %>% 
#     mutate(bmi_group = case_when(
#     bmi_group == "normal" ~ "0_normal",
#     bmi_group == "underweight" ~ "0_normal",
#     bmi_group == "overweight" ~ "2_overweight",
#     bmi_group == "obese" ~ "3_obese"
#   )) %>%
#     mutate(duration_since_heartburn_start = case_when(
#       duration_since_heartburn_start == "Never" ~ "0_Never",
#       duration_since_heartburn_start == "< 5 years" ~ "1_< 5 years",
#       duration_since_heartburn_start == "5-10 years" ~ "2_5-10 years",
#       duration_since_heartburn_start == "> 10 years" ~ "3_> 10 years")) %>% 
#   dplyr::mutate(across(.cols = c(2:13), ~ as.character(.x))) %>% # run to recode implicit NA to "unknown"
#   dplyr::mutate(across(.cols = c(2:13), ~ replace_na(.x, "z_missing"))) # run to recode implicit NA to "unknown"


```

## 2.2 Generate regression matrices

datasets to create:

1.  BE/IM EAC , Non-BE/IM EAC **DONE**

2.  BE/IM EAC , Unknown BE/IM EAC **DONE**

3.  Non-BE/IM EAC , Unknown BE/IM EAC **DONE**

4.  Barretts , BE/IM EAC **DONE**

5.  Barretts , Non-BE/IM EAC **DONE**

6.  Barretts , Unknown BE/IM EAC **DONE**

7.  Control , BE/IM EAC **DONE**

8.  Control , Non-BE/IM EAC **DONE**

9.  Control , Unknown BE/IM EAC **DONE**


```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) %>% 
  drop_na()
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "BE/IM EAC"), ordered = TRUE)) %>% 
  drop_na()
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) %>%
  drop_na()

# Barretts , BE/IM EAC
Barretts_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "BE/IM EAC"), ordered = TRUE)) %>% 
  select(-pTNM_f) %>% 
  drop_na()

# Barretts , Non-BE/IM EAC
Barretts_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Non-BE/IM EAC"), ordered = TRUE)) %>% 
  select(-pTNM_f) %>% 
  drop_na()
# Barretts , Unknown BE/IM EAC
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Barretts", "Unknown BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Unknown BE/IM EAC"), ordered = TRUE)) %>% 
  select(-pTNM_f) %>% 
  drop_na()

# Control , BE/IM EAC
Control_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "BE/IM EAC"), ordered = TRUE))  %>% 
  select(-pTNM_f) %>% 
  drop_na()
# Control , Non-BE/IM EAC  
Control_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "Non-BE/IM EAC"), ordered = TRUE))  %>% 
  select(-pTNM_f) %>% 
  drop_na()
# Control , Unknown BE/IM EAC
Control_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort %>% 
  filter(Phenotype %in% c("Control", "Unknown BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "Unknown BE/IM EAC"), ordered = TRUE)) %>% 
  select(-pTNM_f) %>% 
  drop_na()


# ---------------- generate the same as above but for the exclusion data set ---------------- #

# # BE/IM EAC , Non BE/IM EAC
# BE_IM_EAC_vs_Non_BE_IM_EAC_exclude_surveillance <- 
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 
# # Unknown BE/IM EAC, BE/IM EAC
# BE_IM_EAC_vs_Unknown_BE_IM_EAC_exclude_surveillance <- 
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "BE/IM EAC"), ordered = TRUE)) 
# # Unknown BE/IM EAC, Non BE/IM EAC
# Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_exclude_surveillance <-
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 
# 
# 
# 
# # Barretts , BE/IM EAC
# Barretts_vs_BE_IM_EAC_exclude_surveillance <- 
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Barretts", "BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Barretts", "BE/IM EAC"), ordered = TRUE)) %>% 
#   select(-pTNM_f) %>% 
#   drop_na()
# # Barretts , Non-BE/IM EAC
# Barretts_vs_Non_BE_IM_EAC_exclude_surveillance <-
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Barretts", "Non-BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Barretts", "Non-BE/IM EAC"), ordered = TRUE)) %>% 
#   select(-pTNM_f) %>% 
#   drop_na()
# # Barretts , Unknown BE/IM EAC
# Barretts_vs_Unknown_BE_IM_EAC_exclude_surveillance <-
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Barretts", "Unknown BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Barretts", "Unknown BE/IM EAC"), ordered = TRUE))  %>% 
#   select(-pTNM_f) %>% 
#   drop_na()
# 
# 
# 
# # Control , BE/IM EAC
# Control_vs_BE_IM_EAC_exclude_surveillance <- 
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Control", "BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Control", "BE/IM EAC"), ordered = TRUE))  %>% 
#   select(-pTNM_f) %>% 
#   drop_na()
# # Control , Non-BE/IM EAC  
# Control_vs_Non_BE_IM_EAC_exclude_surveillance <-
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Control", "Non-BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Control", "Non-BE/IM EAC"), ordered = TRUE))  %>% 
#   select(-pTNM_f) %>% 
#   drop_na()
# # Control , Unknown BE/IM EAC
# Control_vs_Unknown_BE_IM_EAC_exclude_surveillance <-
#   occams_best2_all_cohort_exclude_surveillance %>% 
#   filter(Phenotype %in% c("Control", "Unknown BE/IM EAC")) %>%
#   mutate(Phenotype = factor(Phenotype, c("Control", "Unknown BE/IM EAC"), ordered = TRUE)) %>% 
#   select(-pTNM_f) %>% 
#   drop_na()

```

I ran univariable and mutivariable models using the finalfit package - I get the same ORs/CIs using this package or the built in glm() models - just don't use the metrics in the finalfit arguement. I then use the KableExtra package to get column % of variables inclduing missing data. These rest is copy/pasting in Excel

```{r}
dependent <- "Phenotype"
independent <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin',
    'pTNM_f'
  )
independent_no_TNMStage <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin'
    )
```

## 2.3 Complete case analysis

### BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent,   breaks = c(0.5, 1, 5, 10, 20, 30)) 
```

### Unknown_BE_IM_EAC_vs_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent, breaks = c(0.5, 1.00, 1.50, 2.00,  2.50)) 
```

### Unknown_BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data %>%
  # or_plot(dependent, independent)
```

### Barretts_vs_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Barretts_vs_Non_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%   
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_Non_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Barretts_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Barretts_vs_Unknown_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Control_vs_BE_IM_EAC

```{r}
Control_vs_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)

# Control_vs_BE_IM_EAC_logit_model_data %>%
# or_plot(dependent, independent) 
```

### Control_vs_Non_BE_IM_EAC_logit_model_data

```{r}
Control_vs_Non_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```

### Control_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
Control_vs_Unknown_BE_IM_EAC_logit_model_data %>% 
finalfit(dependent, independent_no_TNMStage, column = T)  %>%
  kableExtra::kable(row.names = F) %>%
  kableExtra::kable_styling(full_width = F)
```


# 3. Imputation

## 3.1 Read data

original data that includes all OAC cases whether or not they were under BO Surveillance

```{r}
occams_best2_all_cohort_for_imputation <-
  read_csv('data/processed/chapter.2_occams_best2_all_cohort_20230119.csv') %>%
  select(
    -c(
      ID,
      age,
      ethnicity,
      bmi,
      RP.SiewertClassification,
      acid_suppressant,
      duration_since_heartburn_start,
      pTStage_four_f
    )
  ) %>%
  mutate(
    bmi_group = case_when(
      bmi_group == "normal" ~ "0_normal",
      bmi_group == "underweight" ~ "0_normal",
      bmi_group == "overweight" ~ "2_overweight",
      bmi_group == "obese" ~ "3_obese"
    )
  ) %>%
  mutate(
    age_group = factor(
      age_group,
      c(
        '< 50 years old',
        '50 - 59 years old',
        '60 - 69 years old',
        '70+ years old'
      )
    ),
    gender = factor(gender, c('F', 'M')),
    bmi_group = factor(bmi_group, c('0_normal' , '2_overweight' , '3_obese')),
    smk_ever_smoked = factor(smk_ever_smoked, c("N", "Y")),
    taken_nsaids = factor(taken_nsaids, c("N", "Y")),
    heartburn_inferred_bin = factor(heartburn_inferred_bin, c("N", "Y")),
    pTNM_f = factor(pTNM_f, c("I", "II", "III", "IV"))
  )
```

## 3.2 Prepare imputation

```{r}
library(mice)
```

```{r}

# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort_for_imputation %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort_for_imputation %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "BE/IM EAC"), ordered = TRUE)) 
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort_for_imputation %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Unknown BE/IM EAC", "Non-BE/IM EAC"), ordered = TRUE)) 



# Barretts , BE/IM EAC
Barretts_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Barretts", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "BE/IM EAC"), ordered = TRUE))
# Barretts , Non-BE/IM EAC
Barretts_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Barretts", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Non-BE/IM EAC"), ordered = TRUE))
# Barretts , Unknown BE/IM EAC
Barretts_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Barretts", "Unknown BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Barretts", "Unknown BE/IM EAC"), ordered = TRUE)) 



# Control , BE/IM EAC
Control_vs_BE_IM_EAC_logit_model_data <- 
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Control", "BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "BE/IM EAC"), ordered = TRUE)) 
# Control , Non-BE/IM EAC  
Control_vs_Non_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Control", "Non-BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "Non-BE/IM EAC"), ordered = TRUE)) 
# Control , Unknown BE/IM EAC
Control_vs_Unknown_BE_IM_EAC_logit_model_data <-
  occams_best2_all_cohort_for_imputation %>% 
  select(-pTNM_f) %>% 
  filter(Phenotype %in% c("Control", "Unknown BE/IM EAC")) %>%
  mutate(Phenotype = factor(Phenotype, c("Control", "Unknown BE/IM EAC"), ordered = TRUE))

```


## 3.3 Imputed regression analysis

```{r}
dependent <- "Phenotype"
independent <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin',
    'pTNM_f'
  )

independent_no_TNMStage <-
  c(
    "age_group",
    "gender",
    'bmi_group',
    'smk_ever_smoked',
    'taken_nsaids',
    'heartburn_inferred_bin'
  )

```

### BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
# BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data,
#     m = 52, # for BE EAC vs. non BE EAC
#     # m = 35, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data.rda')

BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data')

BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model <- BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent
  )), family = "binomial"))


BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_pooled <- BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model %>% pool()

BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'BE_IM_EAC_vs_Non_BE_IM_EAC') %>% kableExtra::kable_styling(full_width = FALSE)


# BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_data %>% or_plot(dependent, independent, glmfit = BE_IM_EAC_vs_Non_BE_IM_EAC_logit_model_pooled)

```

### Unknown_BE_IM_EAC_vs_BE_IM_EAC

```{r}
# BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
#     m = 52, # for BE EAC vs. non BE EAC
#     # m = 35, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model <- BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent
  )), family = "binomial"))

BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_pooled <- BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model %>% pool()

BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Unknown_BE_IM_EAC_vs_BE_IM_EAC') %>% kableExtra::kable_styling(full_width = FALSE)

```

### Unknown_BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
# Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_data,
#     m = 52, # for BE EAC vs. non BE EAC
#     # m = 35, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model <- Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent
  )), family = "binomial"))

Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_pooled <- Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model %>% pool()

Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Unknown_BE_IM_EAC_vs_Non_BE_IM_EAC') %>% kableExtra::kable_styling(full_width = FALSE)

```

### Barretts_vs_BE_IM_EAC_logit_model_data

```{r}
# Barretts_vs_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Barretts_vs_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Barretts_vs_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_BE_IM_EAC_logit_model_MI_data')

Barretts_vs_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_BE_IM_EAC_logit_model_MI_data')

Barretts_vs_BE_IM_EAC_logit_model <- Barretts_vs_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Barretts_vs_BE_IM_EAC_logit_model_pooled <- Barretts_vs_BE_IM_EAC_logit_model %>% pool()

Barretts_vs_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Barretts_vs_BE_IM_EAC_logit_model_data') %>% kableExtra::kable_styling(full_width = FALSE)

```

### Barretts_vs_Non_BE_IM_EAC_logit_model_data

```{r}

# Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Barretts_vs_Non_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data')

Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data')


Barretts_vs_Non_BE_IM_EAC_logit_model <- Barretts_vs_Non_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Barretts_vs_Non_BE_IM_EAC_logit_model_pooled <- Barretts_vs_Non_BE_IM_EAC_logit_model %>% pool()

Barretts_vs_Non_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Barretts_vs_Non_BE_IM_EAC_logit_model_data') %>% kableExtra::kable_styling(full_width = FALSE)
```

### Barretts_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
# Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Barretts_vs_Unknown_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

Barretts_vs_Unknown_BE_IM_EAC_logit_model <- Barretts_vs_Unknown_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Barretts_vs_Unknown_BE_IM_EAC_logit_model_pooled <- Barretts_vs_Unknown_BE_IM_EAC_logit_model %>% pool()

Barretts_vs_Unknown_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Barretts_vs_Unknown_BE_IM_EAC_logit_model_data') %>% kableExtra::kable_styling(full_width = FALSE)
```

### Control_vs_BE_IM_EAC

```{r}
# Control_vs_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Control_vs_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Control_vs_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Control_vs_BE_IM_EAC_logit_model_MI_data')

Control_vs_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Control_vs_BE_IM_EAC_logit_model_MI_data')

Control_vs_BE_IM_EAC_logit_model <- Control_vs_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Control_vs_BE_IM_EAC_logit_model_pooled <- Control_vs_BE_IM_EAC_logit_model %>% pool()

Control_vs_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Control_vs_BE_IM_EAC') %>% kableExtra::kable_styling(full_width = FALSE)
```

### Control_vs_Non_BE_IM_EAC_logit_model_data

```{r}
# Control_vs_Non_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Control_vs_Non_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Control_vs_Non_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Control_vs_Non_BE_IM_EAC_logit_model_MI_data')

Control_vs_Non_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Control_vs_Non_BE_IM_EAC_logit_model_MI_data')


Control_vs_Non_BE_IM_EAC_logit_model <- Control_vs_Non_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Control_vs_Non_BE_IM_EAC_logit_model_pooled <- Control_vs_Non_BE_IM_EAC_logit_model %>% pool()

Control_vs_Non_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Control_vs_Non_BE_IM_EAC_logit_model_data') %>% kableExtra::kable_styling(full_width = FALSE)

```

### Control_vs_Unknown_BE_IM_EAC_logit_model_data

```{r}
# Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data <-
#   mice(
#     Control_vs_Unknown_BE_IM_EAC_logit_model_data,
#     # m = 58, # for BE EAC vs. non BE EAC
#     m = 30, # for BE v BE EAC and BE v non-BE EAC and BE v Unknown BE EAC
#     maxit = 20,
#     printFlag = FALSE
#   )
# saveRDS(Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data, 'data/chapter-4-data/imputed-data-for-regression/Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data')

Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data <- readRDS(file = 'data/chapter-4-data/imputed-data-for-regression/Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data')


Control_vs_Unknown_BE_IM_EAC_logit_model <- Control_vs_Unknown_BE_IM_EAC_logit_model_MI_data %>%
  with(glm(formula(ff_formula(
    dependent, independent_no_TNMStage
  )), family = "binomial"))

Control_vs_Unknown_BE_IM_EAC_logit_model_pooled <- Control_vs_Unknown_BE_IM_EAC_logit_model %>% pool()

Control_vs_Unknown_BE_IM_EAC_logit_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'Control_vs_Unknown_BE_IM_EAC_logit_model_data') %>% kableExtra::kable_styling(full_width = FALSE)
```

