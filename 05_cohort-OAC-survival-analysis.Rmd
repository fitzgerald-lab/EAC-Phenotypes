---
title: "04_cohort-OAC-survival-analysis"
author: "Shawn Zamani"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(finalfit)
library(survminer)
library(survival)
library(ggplot2)
library(ggfortify)
library(kableExtra)
```


# 1 Read data

```{r}
occams_cohort_survival <- read_csv('data/processed/chapter.2_survival-analysis_occams-cohort_cleaned-data_20230227.csv') %>%
  # select(-ID) %>% 
  filter(ID != 'OCCAMS/AH/673') %>% # Implausible survival (>208755 weeks/>4014 years), remove observation
  filter(ID != 'OCCAMS/IM/040') %>% # Implausible survival (>90 years), remove observation
  filter(ID != 'OCCAMS/SH/296') %>% # Implausible survival (>1000 years), remove observation
  mutate(dead = case_when(Patient.Died.c == 'yes' ~ 1,
                          Patient.Died.c == 'no' ~ 0,
                          (is.na(Patient.Died.c) & !is.na(Years_Surv)) ~ 0 # right censor those with survival time but not vital status
                          )) %>% 
  mutate(censor = case_when((is.na(Patient.Died.c) & !is.na(Years_Surv)) ~ 'right censored',
                             TRUE ~ 'not censored')) %>% 
  mutate(smk_ever_smoked = case_when(smk_ever_smoked == 'ever' ~ 'Y',
                                     smk_ever_smoked == 'never' ~ 'N',
                                     TRUE ~ smk_ever_smoked)) %>% 
      mutate(bmi_group = case_when(
    bmi_group == "normal" ~ "0_normal",
    bmi_group == "underweight" ~ "0_normal",
    bmi_group == "overweight" ~ "2_overweight",
    bmi_group == "obese" ~ "3_obese"
  )) %>%
  # select(-ID) %>%
  mutate(overall = 'Overall')
```

```{r}
load('data/original/LabKey-occams_pt-tibble_20220617.RData')
overall_cohort <- occams_pt_20220617

tamp_dat <- left_join(occams_cohort_survival %>% select(ID, dead, Years_Surv, Phenotype), overall_cohort %>% select(ID, RP.BarrettsAdjacentToTumour.c,RD.DiagnosisDate.c, FE.LastSeenDate.c, FE.LatestDateOfUpdate.c, FE.LatestReasonForFollowUp.c))
```

## 1.1 Descriprive survival data

### Number of cases with complete survival data

```{r}
occams_cohort_survival %>% 
  filter(!is.na(dead)) %>%       # turn off and run next filder w/o ! to get freq of excluded cases
  filter(!is.na(Years_Surv)) %>% # run w/o ! to get freq of excluded
  # group_by(censor) %>%
  group_by(Phenotype, censor) %>%
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)

occams_cohort_survival %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>% 
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)

# Sensitivty cohort
occams_cohort_survival %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>% 
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

### Person-Years

```{r}
occams_cohort_survival %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>% 
  summarise(n = n(), person_years = sum(Years_Surv)) %>% 
  kable() %>% 
  kable_styling(full_width = F)

# Sensitivty cohort
occams_cohort_survival %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>% 
  summarise(n_complete_surv_data = n(), person_years = sum(Years_Surv)) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

### Number of deaths (events)

```{r}
occams_cohort_survival %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype, dead) %>% 
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)

# Sensitivty cohort
occams_cohort_survival %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype, dead) %>% 
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

### Median FU time (years)

```{r}
occams_cohort_survival %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>%
  summarise(median_FU_years = median(Years_Surv),
            IQR = IQR(Years_Surv),
            min_FU_years = min(Years_Surv),
            max_FU_years = max(Years_Surv),
            mean_FU_years = mean(Years_Surv),
            SD_FU_years = sd(Years_Surv))  %>% 
  kable() %>% 
  kable_styling(full_width = F)


# Sensitivty cohort
occams_cohort_survival %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>%
  summarise(median_FU_years = median(Years_Surv),
            min_FU_years = min(Years_Surv),
            max_FU_years = max(Years_Surv),
            mean_FU_years = mean(Years_Surv),
            SD_FU_years = sd(Years_Surv))  %>% 
  kable() %>% 
  kable_styling(full_width = F)
```


### Entry 

```{r}
  ggplot(data =tamp_dat %>% 
  group_by(RD.DiagnosisDate.c) %>% 
  summarise(n = n()),  aes(RD.DiagnosisDate.c, n)) +
  geom_line(aes(y = cumsum(n))) 


iris.all <- summarize(iris, Sepal.Length = unique(Sepal.Length), 
                            ecdf = ecdf(Sepal.Length)(unique(Sepal.Length)))



occams_cohort_survival %>%
  mutate(`Vital Status` = case_when(
    Patient.Died.c == 'yes' ~ 'Deceased', 
    Patient.Died.c == 'no' & censor == 'not censored'~ 'Alive', 
    censor == 'right censored'~ 'Censored', 
  )) %>% 
  # arrange(rev(vital_status)) %>% 
  mutate(ID = 1:3097) %>% 
  ggplot(aes(x = ID, y = Years_Surv)) +
  geom_linerange(aes(ymin = 0, ymax = Years_Surv)) +
  geom_point(aes(shape = `Vital Status`, color = `Vital Status`),
             stroke = 1,
             cex = 3) +
  scale_shape_manual(values = c(1, 3, 4)) +
  labs(y = "Time (years)", x = "Subject ID") + 
  coord_flip() + 
  theme_bw() +
  ylim(c(0,10)) +
  facet_grid(cols = vars(Phenotype), scales = 'free')
```

## 1.2 Survival metric x baseline characteristics

### Age
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    Phenotype, 
    age_group, 
    end) %>%
  summarise(
    n_freq = n(),
      
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 
    
    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    Phenotype,
    age_group,
    n_freq,
    complete_surv_data,
    right_cens,
    deaths,
    person_years,
    cmr_per_100PY,
    FU_med.min.max.avg.std
  ) %>%
  t() %>%
  kable() %>%
  kable_styling(full_width = F)
```

### Gender
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(Phenotype, gender, end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    Phenotype, gender, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>%
  kable() %>%
  kable_styling(full_width = F)
```


### BMI
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype,
    bmi_group, 
    end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    bmi_group, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### Smoking
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
    smk_ever_smoked, 
    end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    smk_ever_smoked, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### NSAID
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
    taken_nsaids, 
    end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    taken_nsaids, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### Reflux
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
           heartburn_inferred_bin, 
           end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),

    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = "",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    heartburn_inferred_bin, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### pTNM
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
           pTNM_f, 
           end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),

    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = "",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    pTNM_f, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### Siewert Classification
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
           RP.SiewertClassification, end) %>%
  summarise(
    n_freq = n(),
    
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 

    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = "",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype, 
    RP.SiewertClassification, n_freq, complete_surv_data, right_cens, deaths, person_years, cmr_per_100PY, FU_med.min.max.avg.std) %>% 
  t() %>% 
  kable() %>%
  kable_styling(full_width = F)
```

### BO Surveillance
```{r}
occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  mutate(righ_cens = case_when(censor == 'right censored' ~ 1,
                               TRUE ~ 0),
         end = 'end') %>%
  group_by(
    # Phenotype, 
    EX.BarrettsOesophagusUndergoingSurveillance, 
    end) %>%
  summarise(
    n_freq = n(),
      
    death_freq = sum(dead),
    death_prop = death_freq / (n()),
    
    right_cens_freq = sum(righ_cens),
    right_cens_prop = right_cens_freq / (n()),
    
    complete_surv_data_freq = n_freq - right_cens_freq,
    complete_surv_data_prop = complete_surv_data_freq / (n()),
    
    person_years = as.numeric(format(round(sum(Years_Surv),digits = 1), nsmall =1)),
    
    cmr_per_100PY = format(round((death_freq/person_years)*100,digits = 1),nsmall =1), 
    
    median_FU_years = median(Years_Surv),
    # IQR = IQR(Years_Surv),
    min_FU_years = min(Years_Surv),
    max_FU_years = max(Years_Surv),
    mean_FU_years = mean(Years_Surv),
    SD_FU_years = sd(Years_Surv)
  ) %>%
  mutate(
    complete_surv_data_prop = paste0("(", format(
      round(complete_surv_data_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    right_cens_prop = paste0("(", format(
      round(right_cens_prop * 100, digits = 1), nsmall = 1
    ), ")"),
    death_prop = paste0("(", format(round(
      death_prop * 100, digits = 1
    ), nsmall = 1), ")"),
    
    FU_med.min.max.avg.std = 
        paste0(
        format(
        round(median_FU_years, digits = 1), nsmall = 1), " (",
        paste0(
        format(
        round(min_FU_years, digits = 1), nsmall = 1), "-",
        paste0(
        format(
        round(max_FU_years, digits = 1), nsmall = 1), "; ",
        paste0(
        format(
        round(mean_FU_years, digits = 1), nsmall = 1), ", ",
        paste0(
        format(
        round(SD_FU_years, digits = 1), nsmall = 1), ")"
    )))))) %>%
  unite(
    'complete_surv_data',
    sep = " ",
    complete_surv_data_freq:complete_surv_data_prop,
    remove = T
  ) %>%
  unite('right_cens',
        sep = "",
        right_cens_freq:right_cens_prop,
        remove = T) %>%
  unite('deaths',
        sep = "",
        death_freq:death_prop,
        remove = T) %>%
  select(
    # Phenotype,
    EX.BarrettsOesophagusUndergoingSurveillance,
    n_freq,
    complete_surv_data,
    right_cens,
    deaths,
    person_years,
    cmr_per_100PY,
    FU_med.min.max.avg.std
  ) %>%
  t() %>%
  kable() %>%
  kable_styling(full_width = F)
```

# 2 Generate regression matrix

## 2.1 Overall
datasets to create:

1.  BE/IM EAC , Non-BE/IM EAC             **DONE**
2.  BE/IM EAC , Unknown BE/IM EAC         **DONE** 
3.  Non-BE/IM EAC , Unknown BE/IM EAC     **DONE** 

```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data <- 
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>%
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>%
  mutate(Phenotype = case_when(
    Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
    Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
    TRUE ~ Phenotype))
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_cox_model_data <- 
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = case_when(
    Phenotype == "Unknown BE/IM EAC" ~ "0_Unknown BE/IM EAC",
    Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
    TRUE ~ Phenotype))
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_cox_model_data <-
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = case_when(
    Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
    Phenotype == "Unknown BE/IM EAC" ~ "1_Unknown BE/IM EAC",
    TRUE ~ Phenotype))
```
## 2.1 Sensitivity
```{r}
# BE/IM EAC , Non BE/IM EAC
BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_no_surveillance_data <- 
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>%
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>%
  mutate(Phenotype = case_when(
    Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
    Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
    TRUE ~ Phenotype))
# Unknown BE/IM EAC, BE/IM EAC
BE_IM_EAC_vs_Unknown_BE_IM_EAC_cox_model_no_surveillance_data <- 
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "BE/IM EAC")) %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = case_when(
    Phenotype == "Unknown BE/IM EAC" ~ "0_Unknown BE/IM EAC",
    Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
    TRUE ~ Phenotype))
# Unknown BE/IM EAC, Non BE/IM EAC
Non_BE_IM_EAC_vs_Unknown_BE_IM_EAC_cox_model_no_surveillance_data <-
  occams_cohort_survival %>% 
  filter(Phenotype %in% c("Unknown BE/IM EAC", "Non-BE/IM EAC")) %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)) %>%
  mutate(across(.cols = c(5:16), ~ as.character(.x))) %>% 
  mutate(across(.cols = c(5:16), ~ replace_na(.x, "z_missing"))) %>% 
  mutate(Phenotype = case_when(
    Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
    Phenotype == "Unknown BE/IM EAC" ~ "1_Unknown BE/IM EAC",
    TRUE ~ Phenotype))


occams_cohort_survival %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('yes')) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>% 
  summarise(n = n()) %>% 
  kable() %>% 
  kable_styling(full_width = F)

```


# 3 Survival analysis

## 3.1 KM Curves
### 3.1.1 Overall
#### All patients

```{r}
overall_surv_fit <-
  # survfit(Surv(Years_Surv, dead) ~ overall,
  survfit(Surv(Years_Surv, Phenotype) ~ smk_ever_smoked,
          data = occams_cohort_survival %>% 
            mutate(
            Phenotype = as.character(Phenotype)
          ))
# Overall
BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit <- coxph(Surv(Years_Surv, smk_ever_smoked) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data)



overall_vs_overall_w_surveillance_removed <- bind_rows(occams_cohort_survival %>% 
            mutate(indicator = 'surveillance_included'),
          occams_cohort_survival %>% 
            filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)) %>% 
            mutate(indicator = 'no_surveillance_included')
          )
            
overall_surv_vs_overall_surveillance_removed <-
  survfit(Surv(Years_Surv, dead) ~ indicator,
          data = overall_vs_overall_w_surveillance_removed)

ggsurvplot(
  overall_surv_fit,
  # overall_surv_vs_overall_surveillance_removed,
  pval = TRUE,
  pval.method = TRUE, 
  pval.coord = c(1, 0.20),
  pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  # legend.labs = c("BO-ve OAC", "BO+ve OAC"),
  linetype = "solid",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  # palette = c("#333333"),
  xlab = "Time (years)"
)

```

#### BE_IM_EAC_vs_Non_BE_IM_EAC

```{r}
BE_IM_EAC_vs_Non_BE_IM_EAC_surv_fit <- survfit(Surv(Years_Surv, dead) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data)

BE_IM_EAC_vs_Non_BE_IM_EAC_surv_fit <- survfit(Surv(Years_Surv, dead) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>%
filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))

ggsurvplot(
  BE_IM_EAC_vs_Non_BE_IM_EAC_surv_fit,
  pval = TRUE,
  pval.method = TRUE, 
  pval.coord = c(1, 0.20),
  pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  legend.labs = c("BO-ve OAC", "BO+ve OAC"),
  linetype = "strata",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  palette = c("#377eb8", "#e41a1c"),
  xlab = "Time (years)"
)

```


#### Composite

```{r}
occams_cohort_survival_surv_fit <- survfit(Surv(Years_Surv, dead) ~ Phenotype, data = occams_cohort_survival)

occams_cohort_survival %>% 
  ggsurvplot(
  data = .,
  occams_cohort_survival_surv_fit,
  # pval = TRUE,
  # pval.method = TRUE, 
  # pval.coord = c(1, 0.20),
  # pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  tables.height = .2,
  legend.labs = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
  linetype = "strata",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  palette = c("#e41a1c", "#377eb8", "#CC0099"),
  xlab = "Time (years)"
)
```

### 3.1.2 Sensitivity


#### BO Surviellance patients
```{r}
# Never reaches 50th percentile so report 75th percentile
surviellance_surv_fit <-
  survfit(
    Surv(Years_Surv, dead) ~ overall,
    data = occams_cohort_survival %>%  filter(EX.BarrettsOesophagusUndergoingSurveillance == 'yes'))

# 75th percentile
# use 0.248 to obtain approximate value for upper CI limit as .25 would not work
quantile(surviellance_surv_fit, 0.247)
# use the different percentiles for the KM curve line
measures_central_tendency <- data.frame(quartile = c(.25), km = quantile(surviellance_surv_fit))

ggsurvplot(
  surviellance_surv_fit,
  pval = TRUE,
  pval.method = TRUE, 
  pval.coord = c(1, 0.20),
  pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  # legend.labs = c("BO-ve OAC", "BO+ve OAC"),
  linetype = "solid",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  palette = c("#333333"),
  xlab = "Time (years)",
  legend.title="BO Surveillance history"
)$plot +
  # add vertical line 
  geom_segment(data = measures_central_tendency, aes(x = km.quantile, y = 1-quartile, xend = km.quantile, yend = 0), lty = 2) +
  geom_segment(data = measures_central_tendency, aes(x = 0, y = 1-quartile, xend = km.quantile, yend = 1-quartile), lty = 2)


surviellance_phenotype_surv_fit <-
  survfit(
    Surv(Years_Surv, dead) ~ Phenotype,
    data = occams_cohort_survival %>%  filter(EX.BarrettsOesophagusUndergoingSurveillance == 'yes'))

# 75th percentile
# use 0.248 to obtain approximate value for upper CI limit as .25 would not work
quantile(surviellance_phenotype_surv_fit, 0.25)
# use the different percentiles for the KM curve line
measures_central_tendency_surviellance_phenotype <- data.frame(quartile = 0.25, km = quantile(surviellance_phenotype_surv_fit))

ggsurvplot(
  surviellance_phenotype_surv_fit,
  pval = TRUE,
  pval.method = TRUE,
  pval.coord = c(1, 0.20),
  pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  # legend.labs = c("BO-ve OAC", "BO+ve OAC"),
  legend.labs = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
  linetype = "solid",
  # surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  # palette = c("#333333"),
  palette = c("#e41a1c", "#377eb8", "#CC0099"),
  xlab = "Time (years)"
)$plot +
  # add vertical line 
  geom_segment(data = measures_central_tendency_surviellance_phenotype, aes(x = km.quantile.25, y = 1-quartile, xend = km.quantile.25, yend = 0), lty = 2) +
  geom_segment(data = measures_central_tendency_surviellance_phenotype, aes(x = 0, y = 1-quartile, xend = km.quantile.25, yend = 1-quartile), lty = 2)

```



#### Exclude surveillance patients

```{r}
overall_no_surviellance_surv_fit <-
  survfit(
    Surv(Years_Surv, dead) ~ overall,
    data = occams_cohort_survival %>%  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))


all_vs_214 <- survfit(
  Surv(Years_Surv, dead) ~ excluded_vs_all,
  data = occams_cohort_survival %>%
    mutate(excluded_vs_all = case_when(
      EX.BarrettsOesophagusUndergoingSurveillance == 'yes' ~ 'BO Surveillance',
        TRUE ~ 'All other'
    )))


ggsurvplot(
  # overall_no_surviellance_surv_fit,
  all_vs_214,
  pval = TRUE,
  pval.method = TRUE, 
  pval.coord = c(1, 0.20),
  pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  legend.labs = c("No surveillance", "Surveillance"),
  linetype = "solid",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(0, 10),
  ggtheme = theme_bw(),
  palette = c("#333333", "goldenrod"),
  # palette = c("#333333"),
  xlab = "Time (years)"
)


```

#### Exclude < 1 year
```{r}
# Overall
# Exclude under one year only
Sensitivity_overall_excl_under_one_year <-
  survfit(
    Surv(Years_Surv, dead) ~ overall,
occams_cohort_survival %>% 
  filter(Years_Surv >= 1.00))
# Exclude under one year + under surveillance
Sensitivity_overall_excl_under_one_year_and_surveillance <-
  survfit(
    Surv(Years_Surv, dead) ~ Phenotype,
occams_cohort_survival %>% 
  filter(Years_Surv >= 1.00) %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))


# Phenotype
# Exclude under one year only
Sensitivity_phenotype_excl_under_one_year <-
  survfit(
    Surv(Years_Surv, dead) ~ Phenotype,
occams_cohort_survival %>% 
  filter(Years_Surv >= 1.00))
  # filter(Phenotype %in% c('BE/IM EAC', 'Non-BE/IM EAC')))
  # filter(Phenotype %in% c('BE/IM EAC', 'Unknown BE/IM EAC')))
  # filter(Phenotype %in% c('Unknown BE/IM EAC', 'Non-BE/IM EAC')))
# Breakdown
occams_cohort_survival %>%
  # filter(Years_Surv < 1.00) %>% 
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  group_by(Phenotype) %>%
  # group_by(EX.BarrettsOesophagusUndergoingSurveillance) %>%
  count()

# Exclude under one year + under surveillance
Sensitivity_phenotype_excl_under_one_year_and_surveillance <-
  survfit(
    Surv(Years_Surv, dead) ~ Phenotype,
occams_cohort_survival %>% 
  filter(Years_Surv >= 1.00) %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))


ggsurvplot(
  # Sensitivity_overall_excl_under_one_year,
  # Sensitivity_overall_excl_under_one_year_and_surveillance,
  Sensitivity_phenotype_excl_under_one_year,
  # Sensitivity_phenotype_excl_under_one_year_and_surveillance,
  # pval = TRUE,
  # pval.method = TRUE, 
  # pval.coord = c(1, 0.20),
  # pval.method.coord = c(1, 0.08),
  conf.int = TRUE,
  risk.table = TRUE,
  risk.table.col = "strata",
  # risk.table.y.text = FALSE,
  legend.labs = c("BO+ve OAC", "BO-ve OAC", "BO(?) OAC"),
  linetype = "solid",
  surv.median.line = "hv",
  break.time.by = 1,
  xlim = c(1.22, 10),
  ggtheme = theme_bw(),
  palette = c("#e41a1c", "#377eb8", "#CC0099"),
  xlab = "Time (years)"
)
```

## 3.2 Cox regression


```{r}
independent <- c('Phenotype', 'age_group', 'gender', 'bmi_group', 'smk_ever_smoked', 'taken_nsaids', 'heartburn_inferred_bin', 'pTNM_f', 'RP.SiewertClassification')
# 'EX.BarrettsOesophagusUndergoingSurveillance')
independent_base <- c('Phenotype', 'age_group', 'gender')
independent_base_clinical <- c('Phenotype', 'age_group', 'gender',  'pTNM_f'
                               # 'RP.SiewertClassification'
                               )
independent_permute <- c('bmi_group', 'smk_ever_smoked', 'taken_nsaids', 'heartburn_inferred_bin', 'pTNM_f', 'RP.SiewertClassification')
independent_permute_clinical <- c('bmi_group', 'smk_ever_smoked', 'taken_nsaids', 'heartburn_inferred_bin')

dependent = "Surv(Years_Surv, dead)"
```

### BE_IM_EAC_vs_Non_BE_IM_EAC
```{r}
# Overall
BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit <- coxph(Surv(Years_Surv, dead) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data)
# Remove Surveillance
BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit <- coxph(Surv(Years_Surv, dead) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))
# Remove < 1 year of F/U 
BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit <- coxph(Surv(Years_Surv, dead) ~ Phenotype, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>% 
    filter(Years_Surv >= 1.00))

summary(BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit)
ggforest(BE_IM_EAC_vs_Non_BE_IM_EAC_base_cox_fit)



# Overall

BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>%
    filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)) %>% # minus surveillance
  # filter(Years_Surv >= 1.00) %>%                                           # minus < 1 year F/U
  ff_permute(dependent, independent_base_clinical, independent_permute_clinical) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)

# Summary tables
table1::table1(~ Phenotype + age_group + gender + pTNM_f + RP.SiewertClassification + bmi_group + smk_ever_smoked	+ taken_nsaids + heartburn_inferred_bin | dead, data = BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>% 
  filter(EX.BarrettsOesophagusUndergoingSurveillance %in% c('no', NA)))
  # %>% # minus surveillance
  # filter(Years_Surv >= 1.00) )# minus < 1 year F/U
```

### Complete cases

```{r}
BE_IM_EAC_vs_Non_BE_IM_EAC_complete_case <-
  occams_cohort_survival %>%
  select(
    Phenotype,
    Years_Surv,
    dead,
    age_group,
    gender,
    bmi_group,
    smk_ever_smoked,
    taken_nsaids,
    heartburn_inferred_bin,
    pTNM_f
    # RP.SiewertClassification
  ) %>%
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(
    Phenotype = case_when(
      Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
      Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
      TRUE ~ Phenotype
    )
  ) %>%
  mutate(
    age_group = factor(
      age_group,
      c(
        '< 50 years old',
        '50 - 59 years old',
        '60 - 69 years old',
        '70+ years old'
      )
    ),
    gender = factor(gender, c('female', 'male')),
    # bmi_group = factor(bmi_group, c('0_normal' , '2_overweight' , '3_obese')),
    smk_ever_smoked = factor(smk_ever_smoked, c("N", "Y")),
    taken_nsaids = factor(taken_nsaids, c("N", "Y")),
    heartburn_inferred_bin = factor(heartburn_inferred_bin, c("N", "Y")),
    pTNM_f = factor(pTNM_f, c("I", "II", "III", "IV"))
  ) %>% 
  drop_na()

BE_IM_EAC_vs_Non_BE_IM_EAC_complete_case %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  # filter(Years_Surv >= 1.00) %>%                                           # minus < 1 year F/U
  ff_permute(dependent, independent_base_clinical, independent_permute_clinical) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)


table1::table1(~ Phenotype + age_group + gender + pTNM_f + bmi_group + smk_ever_smoked	+ taken_nsaids + heartburn_inferred_bin | dead, data = BE_IM_EAC_vs_Non_BE_IM_EAC_complete_case)
  # %>% # minus surveillance
  # filter(Years_Surv >= 1.00) )# minus < 1 year F/U
```


### MI

```{r}
library(mice)
BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data_to_impute <- occams_cohort_survival %>%
  filter(!is.na(dead)) %>%
  filter(!is.na(Years_Surv)) %>%
  select(
    Phenotype,
    Years_Surv, 
    dead,
    age_group,
    gender,
    bmi_group,
    smk_ever_smoked,
    taken_nsaids,
    heartburn_inferred_bin,
    pTNM_f,
    RP.SiewertClassification
  ) %>%
  filter(Phenotype %in% c("BE/IM EAC", "Non-BE/IM EAC")) %>%
  mutate(
    Phenotype = case_when(
      Phenotype == "Non-BE/IM EAC" ~ "0_Non-BE/IM EAC",
      Phenotype == "BE/IM EAC" ~ "1_BE/IM EAC",
      TRUE ~ Phenotype
    )
  ) %>%   
  mutate(
    age_group = factor(
      age_group,
      c(
        '< 50 years old',
        '50 - 59 years old',
        '60 - 69 years old',
        '70+ years old'
      )
    ),
    gender = factor(gender, c('female', 'male')),
    # bmi_group = factor(bmi_group, c('0_normal' , '2_overweight' , '3_obese')),
    smk_ever_smoked = factor(smk_ever_smoked, c("N", "Y")),
    taken_nsaids = factor(taken_nsaids, c("N", "Y")),
    heartburn_inferred_bin = factor(heartburn_inferred_bin, c("N", "Y")),
    pTNM_f = factor(pTNM_f, c("I", "II", "III", "IV"))
  )


  
imp_fits_data <- mice(BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data_to_impute, m=1,maxit=1)
imp_fits_data$method

# no need to map methods as mice auto map worked fine
imp_methods <- imp_fits_data$method
imp_methods["Phenotype"] <- ""
imp_methods["Years_Surv"] <- ""
imp_methods["dead"] <- ""
imp_methods["age_group"] <- ""
imp_methods["gender"] <- ""
imp_methods["bmi_group"] <- "polyreg"
imp_methods["smk_ever_smoked"] <- "logreg"
imp_methods["taken_nsaids"] <- "logreg"
imp_methods["heartburn_inferred_bin"] <- "logreg"
imp_methods["pTNM_f"] <- "polyreg"
imp_methods["RP.SiewertClassification"] <- "polyreg"


BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_MI_data <-
  mice(
    BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data_to_impute,
    m = 5, # for BE EAC vs. non BE EAC
    maxit = 5,
    method =imp_methods,
    printFlag = FALSE
  )



BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model <- BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_MI_data %>%
  with(coxph(formula(ff_formula(
    dependent, independent
  ))))


BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_pooled <- BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model %>% pool()

BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_pooled %>% fit2df(estimate_name = "OR (Multivar using MI)", exp = TRUE) %>% kableExtra::kable(caption = 'BE_IM_EAC_vs_Non_BE_IM_EAC') %>% kableExtra::kable_styling(full_width = FALSE)

```



#### PH assumption

```{r}
explanatory = c("age", "gender", "Phenotype", "smk_ever_smoked")
dependent_os = "Surv(Years_Surv, dead)"
BE_IM_EAC_vs_Non_BE_IM_EAC_cox_model_data %>% 
    coxphmulti(dependent_os, explanatory) %>% 
    cox.zph() %>% 
    {zph_result <<- .} %>% 
    plot(var=4)
```

