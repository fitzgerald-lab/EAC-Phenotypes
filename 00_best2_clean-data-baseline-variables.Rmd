---
title: "best2_descriptive-statistics"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Objective

Generate descriptive statistics tables (Table 1) for the following cohorts:

-   [ ] OCCAMS
-   [x] BEST2
-   [ ] Mutograph

# Setup

```{r setup}
library(tidyverse)
library(lubridate)
library(readxl)
library(table1)
library(kableExtra)
```

```{r read_data}
best2_2022_baseline_crf <- read_xlsx('data/original/best2/BEST2_BASELINE_CRF.xlsx')
best2_2022_meds_crf <- read_xlsx('data/original/best2/BEST2_MEDICATION_CRF.xlsx')
best2_2022_nsaids_crf <- read_xlsx('data/original/best2/BEST2_NSAID_SUBFORM.xlsx')
best2_case_cont_dob_crf <-  readxl::read_xlsx('data/original/best2/BEST2_PATIENT.xlsx') %>% select(PATIENT_ID, STUDY_ARM, YEAR_OF_BIRTH)
```

# Filter cohort

- Include both cases and controls
- Exclude "indeterminate" patients (not many of them anyways)
- Deduplicate the dataset

```{r case_cont}
best2_case_cont_dob_crf %>% group_by(STUDY_ARM) %>% summarize(`frequency` =  n()) %>% 
  kable(caption = 'freq. of cases and controls in the dataset') %>% 
  kable_styling(
    full_width = FALSE,
    position = 'c',
    bootstrap_options = c('striped', 'hover'))
```


```{r filter_cohort}
filtered_best2_baseline <- left_join(best2_2022_baseline_crf, best2_case_cont_dob_crf, "PATIENT_ID") %>% 
  relocate(c(STUDY_ARM, YEAR_OF_BIRTH, BE_FIRST_BE_DIAG),.after = PATIENT_ID) %>% 
  filter(STUDY_ARM != 'Indeterminate')

filtered_best2_baseline_patient_ID <- filtered_best2_baseline %>% select(PATIENT_ID)
```


# Clean data
### age

```{r}
set.seed(123)
cases_missing_age <- filtered_best2_baseline %>%
  select(PATIENT_ID, STUDY_ARM, YEAR_OF_BIRTH) %>%
  filter(is.na(YEAR_OF_BIRTH)) %>%
  filter(STUDY_ARM == 'Case')

cases_age_50_imputed <- left_join(
  cases_missing_age,
  cases_missing_age %>%
    slice_sample(prop = 0.186, replace = F) %>%
    mutate(age_group_imputed = '< 50 years old'), 
  c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

cases_age_50_50to59_imputed <- left_join(
  cases_age_50_imputed,
  cases_age_50_imputed %>%
    filter(is.na(age_group_imputed)) %>%
    slice_sample(n = 82, replace = F) %>%
    mutate(age_group_imputed = '50 - 59 years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

cases_age_50_50to59_60to69_imputed <- left_join(
  cases_age_50_50to59_imputed,
  cases_age_50_50to59_imputed %>%
    filter(is.na(age_group_imputed.x)) %>%
    filter(is.na(age_group_imputed.y)) %>%
    slice_sample(n = 103, replace = F) %>%
    mutate(age_group_imputed = '60 - 69 years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

cases_age_50_50to59_60to69_70plus_imputed <- left_join(
  cases_age_50_50to59_60to69_imputed,
  cases_age_50_50to59_60to69_imputed %>%
    filter(is.na(age_group_imputed)) %>%
    filter(is.na(age_group_imputed.x.x)) %>%
    filter(is.na(age_group_imputed.x.y)) %>%
    filter(is.na(age_group_imputed.y.y)) %>%
    filter(is.na(age_group_imputed.y.x)) %>%
    slice_sample(n = 74, replace = F) %>%
    mutate(age_group_imputed = '70+ years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

cases_imputed_age_group <-
  cases_age_50_50to59_60to69_70plus_imputed %>% mutate(
    age_group_imputed = coalesce(
      age_group_imputed.x.x.x,
      age_group_imputed.y.x.x,
      age_group_imputed.x.y.x,
      age_group_imputed.y.y.x,
      age_group_imputed.x,
      age_group_imputed.x.x.y,
      age_group_imputed.y.x.y,
      age_group_imputed.x.y.y,
      age_group_imputed.y.y.y,
      age_group_imputed.y
    )
  ) %>% 
  select(PATIENT_ID, STUDY_ARM, age_group_imputed)

# ------------- controls ------------- #
controls_missing_age <- filtered_best2_baseline %>%
  select(PATIENT_ID, STUDY_ARM, YEAR_OF_BIRTH) %>%
  filter(is.na(YEAR_OF_BIRTH)) %>%
  filter(STUDY_ARM == 'Control')

controls_age_50_imputed <- left_join(
  controls_missing_age,
  controls_missing_age %>%
    slice_sample(n = 32, replace = F) %>%
    mutate(age_group_imputed = '< 50 years old'), 
  c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

controls_age_50_50to59_imputed <- left_join(
  controls_age_50_imputed,
  controls_age_50_imputed %>%
    filter(is.na(age_group_imputed)) %>%
    slice_sample(n = 23, replace = F) %>%
    mutate(age_group_imputed = '50 - 59 years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

controls_age_50_50to59_60to69_imputed <- left_join(
  controls_age_50_50to59_imputed,
  controls_age_50_50to59_imputed %>%
    filter(is.na(age_group_imputed.x)) %>%
    filter(is.na(age_group_imputed.y)) %>%
    slice_sample(n = 25, replace = F) %>%
    mutate(age_group_imputed = '60 - 69 years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

controls_age_50_50to59_60to69_70plus_imputed <- left_join(
  controls_age_50_50to59_60to69_imputed,
  controls_age_50_50to59_60to69_imputed %>%
    filter(is.na(age_group_imputed)) %>%
    filter(is.na(age_group_imputed.x.x)) %>%
    filter(is.na(age_group_imputed.x.y)) %>%
    filter(is.na(age_group_imputed.y.y)) %>%
    filter(is.na(age_group_imputed.y.x)) %>%
    slice_sample(n = 15, replace = F) %>%
    mutate(age_group_imputed = '70+ years old'),
    c('PATIENT_ID', 'STUDY_ARM', 'YEAR_OF_BIRTH')
)

controls_imputed_age_group <-
  controls_age_50_50to59_60to69_70plus_imputed %>% mutate(
    age_group_imputed = coalesce(
      age_group_imputed.x.x.x,
      age_group_imputed.y.x.x,
      age_group_imputed.x.y.x,
      age_group_imputed.y.y.x,
      age_group_imputed.x,
      age_group_imputed.x.x.y,
      age_group_imputed.y.x.y,
      age_group_imputed.x.y.y,
      age_group_imputed.y.y.y,
      age_group_imputed.y
    )
  ) %>% 
  select(PATIENT_ID, STUDY_ARM, age_group_imputed)

# bind_rows(cases_imputed_age_group, controls_imputed_age_group)
```

```{r clean_epid}
filtered_best2_baseline_clean <-
  left_join(filtered_best2_baseline, 
            bind_rows(cases_imputed_age_group, controls_imputed_age_group), 
            c('PATIENT_ID', 'STUDY_ARM')) %>% 
  select(
    PATIENT_ID,
    CRF_ID,
    STUDY_ARM,
    CREATED_DATE, # date of date entry which is very close to date of endoscopy etc
    YEAR_OF_BIRTH,
    age_group_imputed,
    BE_FIRST_BE_DIAG,
    SEX,
    ETHNICITY,
    BMI,
    WEIGHT_AT_AGE_20,
    HEIGHT,
    WAIST_TO_HIP_RATIO,
    EDUCATION_LEVEL,
    TAKEN_NSAIDS,
    contains('SMK_', ignore.case = FALSE),
    contains('ALC_', ignore.case = FALSE),
    contains('SYM_', ignore.case = FALSE),
    # contains('TSM_', ignore.case = FALSE), TSM is much less well recorded compared to SYM
    BE_PRAGUE_C,
    BE_PRAGUE_M
  ) %>%
  mutate(first_be_diag_date = year(dmy(BE_FIRST_BE_DIAG)), # calculate age for cases
         age_at_first_be_diag = first_be_diag_date - YEAR_OF_BIRTH) %>% 
  
  mutate(SEX = case_when(is.na(SEX) ~ 'M',
                         TRUE ~ SEX)) %>% 

  mutate(recruited_date = year(dmy(CREATED_DATE)),   # calculate age for controls
    age_at_baseline_controls = recruited_date - YEAR_OF_BIRTH) %>% 
  
  mutate(age_at_be_diag_or_baseline = case_when(
    is.na(age_at_first_be_diag) ~ age_at_baseline_controls,
    TRUE ~ age_at_first_be_diag)) %>%
  
  # mutate(age_at_be_diag_or_baseline = case_when(
    # is.na()
  # ))
  # remove intermediate variables
  relocate(.after = SEX, age_at_be_diag_or_baseline) %>% 
  select(-c(BE_FIRST_BE_DIAG, CREATED_DATE, recruited_date, first_be_diag_date, age_at_first_be_diag, YEAR_OF_BIRTH, age_at_baseline_controls)) %>% 
  janitor::clean_names() %>% 
  rename(
    gender = sex,
    crf_ID = crf_id,
    patient_ID = patient_id) %>% 
    mutate(
    ethnicity = case_when(ethnicity %in% c(1:3) ~ "White", ethnicity %in% c(4:15) ~ "Other"),
    bmi_at_age_20 = round(weight_at_age_20 / ((height / 100) ^ 2), digits = 2),
    highest_education = case_when(
      education_level == 1 ~ "School up to 15-16",
      education_level == 2 ~ "College or vocational school",
      education_level == 3 ~ "University graduate",
      education_level == 4 ~ "Professional training beyond college/postgraduate degree",
      education_level == 5 ~ "Other",
      education_level == 5 ~ "Refused",
      TRUE ~ as.character(education_level)
    ),
    smk_years_smoking = smk_age_smoking_stopped - smk_age_started,
    smk_pack_years_c = abs((smk_cigarettes_per_day / 20) * (smk_age_smoking_stopped - smk_age_started)),
    
    smk_years_smoking = na_if(smk_years_smoking, 0),
    smk_cigarettes_per_day = na_if(smk_cigarettes_per_day, 0),
    smk_pack_years_c = na_if(smk_pack_years_c, 0),
    
    alc_intake_frequency = case_when(
      alc_intake_frequency == "D" ~ "Daily",
      alc_intake_frequency == "N" ~ "None",
      alc_intake_frequency == "W" ~ "Weekly",
      alc_intake_frequency == "O" ~ "Occasional (once / twice per month)",
      TRUE ~ alc_intake_frequency
    ),
    alc_preferred_drink = case_when(
      alc_preferred_drink == 1 ~ "Red wine",
      alc_preferred_drink == 2 ~ "White wine",
      alc_preferred_drink == 3 ~ "Spirits",
      alc_preferred_drink == 4 ~ "Beer",
      alc_preferred_drink == 5 ~ "Other",
      alc_preferred_drink == 6 ~ "None",
      TRUE ~ as.character(alc_preferred_drink)
    ),
    
    alc_units_per_week = na_if(alc_units_per_week, 0),
    
    # sym_yrs_since_heartburn_start = as.character(duration_since_heartburn_start), 
    
    duration_since_heartburn_start_temp = case_when(
      sym_yrs_since_heartburn_start == 1 ~ "Never",
      sym_yrs_since_heartburn_start %in% c(2:5) ~ "< 5 years",
      sym_yrs_since_heartburn_start == 6 ~ "5-10 years",
      sym_yrs_since_heartburn_start %in% c(7:8) ~ "> 10 years",
      # sym_acid_taste == "N" &
        # sym_yrs_since_heartburn_start %in% c("< 5 years", "5-10 years", "> 10 years") ~ 'Unknown_never_freq',
      TRUE ~ as.character(sym_yrs_since_heartburn_start)
    ), 
      
    duration_since_heartburn_start = case_when(
      sym_acid_taste %in% c("N") & is.na(duration_since_heartburn_start_temp) ~ "Never",
      sym_acid_taste %in% c("S", "O", "D") & is.na(duration_since_heartburn_start_temp) ~ "Unknown",
      sym_acid_taste %in% c("S", "O", "D") & duration_since_heartburn_start_temp == "Never" ~ 'Unknown',
      TRUE ~ as.character(duration_since_heartburn_start_temp)
    ),
    
    frequency_acid_taste_temp = case_when(
        sym_acid_taste == "N" ~ 'Never',
        sym_acid_taste == "S" ~ 'Sometimes',
        sym_acid_taste == "O" ~ 'Often',
        sym_acid_taste == "D" ~ 'Daily',
        TRUE ~ sym_acid_taste
    ),
    
    frequency_acid_taste = case_when(
        duration_since_heartburn_start %in% c("< 5 years", "5-10 years", "> 10 years") & is.na(frequency_acid_taste_temp) ~ 'Unknown',
        duration_since_heartburn_start %in% c("< 5 years", "5-10 years", "> 10 years") & frequency_acid_taste_temp == 'Never' ~ 'Unknown',
        duration_since_heartburn_start_temp == "Unknown_never_freq" ~ 'Unknown',
        TRUE ~ as.character(frequency_acid_taste_temp)),
    across(
      .cols = c(
        sym_chest_pain,
        sym_burning_chest,
        sym_acid_taste,
        sym_stomach_pain,
        sym_sore_throat,
        sym_sleep_disrupted,
        sym_diet_disrupted,
        sym_activity_disrupted
      ),
      .fns = RefluxCodesGIS
    ),
    
    global_GIS = # calculate global gerd impact scale
      sym_chest_pain +
      sym_burning_chest +
      sym_acid_taste +
      sym_stomach_pain +
      sym_sore_throat +
      sym_sleep_disrupted +
      sym_diet_disrupted +
      sym_activity_disrupted,
    
    global_GERD_GIS = # calculate only the GERD subscore (no QOL score)
      sym_chest_pain +
      sym_burning_chest +
      sym_acid_taste +
      sym_stomach_pain +
      sym_sore_throat,
    across( # convert scores back to character
      .cols = c(
        sym_chest_pain,
        sym_burning_chest,
        sym_acid_taste,
        sym_stomach_pain,
        sym_sore_throat,
        sym_sleep_disrupted,
        sym_diet_disrupted,
        sym_activity_disrupted
      ),
      .fns = RefluxCodes
    )) %>%
  mutate(
    be_prague_c = case_when(be_prague_c =='<1' ~ 0.5,
                            TRUE ~ as.double(be_prague_c)), 
    be_prague_m = case_when(be_prague_m =='<1' ~ 0.5,
                            TRUE ~ as.double(be_prague_m)), 
    be_prague_c = na_if(be_prague_c, c(0)),
    be_prague_c = na_if(be_prague_c, c(-1)),
    be_prague_m = na_if(be_prague_m, c(0)),
    be_prague_m = na_if(be_prague_m, c(-1)),
    
    be_prague_c = as.double(be_prague_c),
    be_prague_m = as.double(be_prague_m)
  ) %>% 
    mutate(bmi = case_when(
  bmi == 0.0 ~ NA_integer_,
  bmi > 70.0 ~ NA_integer_,
  TRUE ~ as.integer(bmi)
    )) %>%
  mutate(bmi_group = factor(
    case_when(
      bmi < 18.5 ~ "underweight",
      bmi >= 18.5 & bmi < 25 ~ "normal",
      bmi >= 25 & bmi < 30 ~ "overweight",
      bmi >= 30 ~ "obese",
      bmi > 70 ~ NA_character_
    ),
    levels = c("normal",
               "underweight",
               "overweight",
               "obese"),
    ordered = TRUE
  )) %>% 
    mutate(bmi_group_at_age_20 = factor(
    case_when(
      bmi_at_age_20 < 18.5 ~ "underweight",
      bmi_at_age_20 >= 18.5 & bmi_at_age_20 < 25 ~ "normal",
      bmi_at_age_20 >= 25 & bmi_at_age_20 < 30 ~ "overweight",
      bmi_at_age_20 >= 30 ~ "obese",
      bmi_at_age_20 > 70 ~ NA_character_
    ),
    levels = c("normal",
               "underweight",
               "overweight",
               "obese"),
    ordered = TRUE
  )) %>% 
  mutate(age_group = factor(
    case_when(
      age_at_be_diag_or_baseline < 50 ~ "< 50 years old",
      age_at_be_diag_or_baseline >= 50 & age_at_be_diag_or_baseline < 60 ~ "50 - 59 years old",
      age_at_be_diag_or_baseline >= 60 & age_at_be_diag_or_baseline < 70 ~ "60 - 69 years old",
      age_at_be_diag_or_baseline >= 70 ~ "70+ years old",
      TRUE ~ age_group_imputed
      # age_at_be_diag_or_baseline >= 80 ~ "80+ years old"
    ),
    # levels = c(
    #   "< 50 years old",
    #   "50 - 59 years old",
    #   "60 - 69 years old",
    #   "70+ years old"
    #   # "80+ years old"
    # ),
    ordered = TRUE
  )) %>% 
  mutate(
    Phenotype = case_when(
      study_arm == "Case" ~ "Barretts",
      study_arm == "Control" ~ "Control",
      study_arm == "Indeterminate" ~ "Indeterminate"
    )
  ) %>% 
  select(-c(weight_at_age_20, height, education_level, smk_age_smoking_stopped, smk_age_started)) %>%
  relocate(bmi_at_age_20, .after = bmi) %>%
  relocate(highest_education, .after = ethnicity) %>%
  relocate(c(smk_years_smoking, smk_pack_years_c), .after = smk_cigarettes_per_day) %>% 
  relocate(c(global_GIS, global_GERD_GIS), .after = sym_yrs_since_acid_taste_start) %>% 
  relocate(c(duration_since_heartburn_start, frequency_acid_taste), .after = global_GERD_GIS) 

```



## epidemiology/reflux

If GORD impact scale is 32, then that means every variable used to calculate GIS was 'never' which is worth 4 points. Those missing GIS scores are truly missing this data and everyone else has experienced heartburn to some extent. 
```{r gerd_funcs}
RefluxCodes <- function(x) {
case_when(x == 4 ~ "Never",
          x == 3 ~ "Sometimes",
          x == 2 ~ "Often",
          x == 1 ~ "Daily",
          TRUE ~ as.character(x))
}

RefluxCodesGIS <- function(x) {
  case_when(x == "N" ~ 4,
            x == "S" ~ 3,
            x == "O" ~ 2,
            x == "D" ~ 1,
            TRUE ~ as.double(x))
}
```

## PPI medication
```{r}
best2_2022_meds_clean <- best2_2022_meds_crf %>% 
  filter(BEST2_MEDICINE != 99) %>% 
  filter(BEST2_MEDICINE != 3) %>% 
  filter(BEST2_MEDICINE != 4) %>% 
  filter(BEST2_MEDICINE != 7) %>% 
  filter(BEST2_MEDICINE != 13) %>% 
  mutate(
  BEST2_MEDICINE = case_when(
    BEST2_MEDICINE %in% c(5, 8, 10, 12, 14, 15, 16) ~ 'PPI',
    BEST2_MEDICINE %in% c(6, 9) ~ 'OTC',
    BEST2_MEDICINE %in% c(2, 16) ~ 'H2RA'
  ),
  
  DOSE_UNITS = case_when(
    DOSE_UNITS == 1 ~ 'g',
    DOSE_UNITS == 2 ~ 'mg',
    DOSE_UNITS == 3 ~ 'mcg',
    DOSE_UNITS == 4 ~ 'mls',
    DOSE_UNITS == 5 ~ 'other',
    DOSE_UNITS == 6 ~ 'IU'
  ),
  
  DOSE_FREQUENCY = case_when(
    DOSE_FREQUENCY == 1 ~'Once per day', 
    DOSE_FREQUENCY == 2 ~'Twice per day', 
    DOSE_FREQUENCY == 3 ~'Three times per day', 
    DOSE_FREQUENCY == 4 ~'Four times per day', 
    DOSE_FREQUENCY == 5 ~'On Demand', 
    DOSE_FREQUENCY == 6 ~'Dont know', 
    DOSE_FREQUENCY == 7 ~'Other'
  ), 
  duration_use_yrs = YEAR_STOPPED - YEAR_STARTED) %>% 
  unite('dosage', DOSE:DOSE_UNITS, na.rm = T, remove = F) %>% 
select(
  PATIENT_ID,
  CRF_ID,
  BEST2_MEDICINE,
  # DOSE,
  # DOSE_UNITS,
  DOSE_FREQUENCY,
  # dosage,
  # YEAR_STARTED,
  # YEAR_STOPPED,
  duration_use_yrs,
  # MEDICATION_STATUS
)

wide_frequency <- best2_2022_meds_clean %>% pivot_wider(id_cols = PATIENT_ID, names_from = BEST2_MEDICINE, values_from = c(DOSE_FREQUENCY)) %>% 
    mutate(
        PPI_frequency = case_when(
            PPI == 'NULL' ~ 'N',
            TRUE ~ 'Y'),
        
        OTC_frequency = case_when(
            OTC == 'NULL' ~ 'N',
            TRUE ~ 'Y'),
        
        H2RA_frequency = case_when(
            H2RA == 'NULL' ~ 'N',
            TRUE ~ 'Y')
    ) %>% select(-c(PPI, OTC, H2RA))

wide_duration_PPI <-
  best2_2022_meds_clean %>%   
  pivot_wider(names_from = BEST2_MEDICINE, values_from = c(duration_use_yrs)) %>% arrange(PATIENT_ID,-PPI) %>% group_by(PATIENT_ID) %>% 
  slice(L = 1) %>% 
  select(
    PATIENT_ID,
    PPI_duration_yrs = PPI,
  )

wide_duration_OTC <-
  best2_2022_meds_clean %>%   
  pivot_wider(names_from = BEST2_MEDICINE, values_from = c(duration_use_yrs)) %>% arrange(PATIENT_ID,-OTC) %>% group_by(PATIENT_ID) %>% 
  slice(L = 1) %>% 
  select(
    PATIENT_ID,
    OTC_duration_yrs = OTC
  )

wide_duration_H2RA <-
  best2_2022_meds_clean %>%   
  pivot_wider(names_from = BEST2_MEDICINE, values_from = c(duration_use_yrs)) %>% arrange(PATIENT_ID,-OTC) %>% group_by(PATIENT_ID) %>% 
  slice(L = 1) %>% 
  select(
    PATIENT_ID,
    H2RA_duration_yr = H2RA
  )

wide_duration <- bind_cols(wide_duration_PPI, wide_duration_OTC, wide_duration_H2RA) %>% 
  select( -c(`PATIENT_ID...3`, `PATIENT_ID...5`)) %>% 
  rename(PATIENT_ID = `PATIENT_ID...1`) %>% 
  mutate(across(2:4, ~ na_if(., 0)))

wide <- left_join(wide_frequency, wide_duration, "PATIENT_ID") 

meds <-
  left_join(filtered_best2_baseline_patient_ID, wide, "PATIENT_ID") %>%
  mutate(across(2:4, ~ if_else(is.na(.), 'N', .))) %>% 
  mutate(
    ACID_SUPPRESSANT = case_when(
      (PPI_frequency == 'Y' | OTC_frequency == 'Y' | H2RA_frequency == 'Y') ~ 'Y',
      TRUE ~ 'N'
    ),
    # ACID_SUPPRESSANT = if_else(PPI_frequency == 'N', 'N', PPI_frequency),
    ACID_SUPPRESSANT = if_else(
      is.na(PPI_frequency) &
        is.na(OTC_frequency) &
        is.na(H2RA_frequency),
      "NA",
      ACID_SUPPRESSANT
    ),
    ACID_SUPPRESSANT = na_if(ACID_SUPPRESSANT, "NA")
  )
```


## aspirin/NSAID
```{r}
nsaids_clean <- 
  left_join(
    filtered_best2_baseline %>% select(PATIENT_ID, CRF_ID, TAKEN_NSAIDS),
    best2_2022_nsaids_crf %>% select(
      -c(
        RECORD_ID,
        CREATED_BY,
        CREATED_DATE,
        LAST_UPDATED,
        LAST_UPDATED_BY
      )
    ),
    c("CRF_ID")
  ) %>% 
      mutate(
  NSAID_NAME = case_when(
    NSAID_NAME == 1 ~ 'aspirin',
    NSAID_NAME == 2 ~ 'other',
    TRUE ~ as.character(NSAID_NAME)),
  
  TAKEN_NSAIDS = case_when(
    is.na(TAKEN_NSAIDS) & !is.na(NSAID_NAME) ~ 'Y',
    TAKEN_NSAIDS == 'N' & !is.na(NSAID_NAME) ~ 'Y',
    TRUE ~ TAKEN_NSAIDS),
  
  NSAID_OTHER = str_to_lower(NSAID_OTHER),
  
  DOSE_FREQUENCY = case_when(
    DOSE_FREQUENCY == 1 ~ 'Once per day',
    DOSE_FREQUENCY == 2 ~ 'Twice per day',
    DOSE_FREQUENCY == 3 ~ 'Three times per day',
    DOSE_FREQUENCY == 4 ~ 'Four times per day',
    DOSE_FREQUENCY == 5 ~ 'On Demand',
    DOSE_FREQUENCY == 6 ~ 'Dont know',
    DOSE_FREQUENCY == 7 ~ 'Other',
    TRUE ~ as.character(DOSE_FREQUENCY)),
  
  DOSE_UNITS = case_when(
    DOSE_UNITS == 1 ~ 'g',
    DOSE_UNITS == 2 ~ 'mg',
    DOSE_UNITS == 3 ~ 'mcg',
    DOSE_UNITS == 4 ~ 'mls',
    DOSE_UNITS == 5 ~ 'other',
    DOSE_UNITS == 6 ~ 'IU'
  ),
  MEDICATION_STATUS = case_when(
    MEDICATION_STATUS == 'C' ~ 'Currently taking',
    MEDICATION_STATUS == 'S' ~ 'Stopped taking',
    MEDICATION_STATUS == 'X' ~ 'Dont know',
    TRUE ~ as.character(MEDICATION_STATUS)),
  DURATION_NSAID_YRS = (YEAR_STOPPED - YEAR_STARTED)) %>% 
  unite('dosage', DOSE:DOSE_UNITS, na.rm = T, remove = F) %>% 
  select(
    PATIENT_ID,
    CRF_ID,
    NSAID_NAME,
    TAKEN_NSAIDS,
    DURATION_NSAID_YRS,
    # DOSE,
    # DOSE_UNITS,
    DOSE_FREQUENCY
  )


wide_frequency_nsaids <- nsaids_clean %>% 
  mutate(DOSE_FREQUENCY = case_when(
    TAKEN_NSAIDS == 'N' ~ 'never',
    DOSE_FREQUENCY %in% c("Once per day", "Four times per day", "On Demand", "Three times per day", "Twice per day", "Dont know", "Other") ~ 'ever',
    TRUE ~ DOSE_FREQUENCY
  )) %>% 
  mutate(NSAID_NAME = case_when(
    is.na(NSAID_NAME) ~ 'missing', 
    TRUE ~ NSAID_NAME)) %>% 
  pivot_wider(id_cols = PATIENT_ID, names_from = NSAID_NAME, values_from = c(DOSE_FREQUENCY)) %>% 
    mutate(
        missing = case_when(
            missing == 'NULL' ~ NA_character_,
            TRUE ~ as.character(missing)),
        
        aspirin = case_when(
            aspirin == 'NULL' ~ NA_character_,
            TRUE ~ 'ever'),
        
        other = case_when(
            other == 'NULL' ~ NA_character_,
            TRUE ~ 'ever')) %>% 
   mutate(
        aspirin = case_when(
            missing == 'never' ~ 'never',
            TRUE ~ aspirin),
        
        other = case_when(
            missing == 'never' ~ 'never',
            TRUE ~ other)) %>% 
  select(-missing) %>% 
  rename(other_nsaid = other)

duration_nsaid <- nsaids_clean %>% 
  select(PATIENT_ID, NSAID_NAME, DURATION_NSAID_YRS) %>% 
  mutate(DURATION_NSAID_YRS = na_if(DURATION_NSAID_YRS, 0)) %>% 
  pivot_wider(names_from = NSAID_NAME, values_from = DURATION_NSAID_YRS, values_fn = list(DURATION_NSAID_YRS = min)) %>%  # takes the max duratio when there are duplicates
  select(-`NA`) %>% 
  rename(Aspirin_Total_Years_n = aspirin,
         Other_NSAID_Total_Years_n = other)


nsaids_clean_wide <- left_join(wide_frequency_nsaids, duration_nsaid, "PATIENT_ID") 


```


```{r}
filtered_best2_baseline_meds_clean <- left_join(
  left_join(
    filtered_best2_baseline_clean %>% select(-taken_nsaids),
    meds,
    c("patient_ID" = "PATIENT_ID")
  ),
  nsaids_clean_wide,
  c("patient_ID" = "PATIENT_ID")
) %>% 
    mutate(TAKEN_NSAIDS = case_when(
      other_nsaid %in% c('ever') | aspirin %in% c('ever') ~ "Y",
      TRUE ~ "N"
    ),
    TAKEN_NSAIDS = if_else(is.na(other_nsaid) & is.na(aspirin), "NA", TAKEN_NSAIDS),
    TAKEN_NSAIDS = na_if(TAKEN_NSAIDS, "NA"))

```

## reflux inference

```{r reflux, include=FALSE}
filtered_best2_baseline_meds_reflux <- filtered_best2_baseline_meds_clean %>%
  # select(duration_since_heartburn_start, frequency_acid_taste, ACID_SUPPRESSANT) %>% 
  mutate(heartburn_inferred_bin =
           case_when(
             (
               duration_since_heartburn_start %in% c('< 5 years', '5-10 years', '> 10 years', 'Unknown') |
                 frequency_acid_taste %in% c("Sometimes", "Often", "Daily", 'Unknown') |
                 ACID_SUPPRESSANT == 'Y'
             ) ~ 'Y',
             (
               is.na(duration_since_heartburn_start)  &
                 is.na(frequency_acid_taste) &
                 is.na(ACID_SUPPRESSANT)
             ) ~ NA_character_,
             
             TRUE ~ 'N'
           ))
```


# Descriptive stats



```{r desc_table_data, echo=FALSE, fig.align='center'}
best2_descriptive_table1_data <-
  filtered_best2_baseline_meds_reflux  %>%  
  select(
    -c(
      patient_ID,
      crf_ID,
      sym_yrs_since_heartburn_start,
      sym_yrs_since_acid_taste_start,
      duration_since_heartburn_start_temp,
      frequency_acid_taste_temp
    )
  )

best2_table1 <- table1(~ . | Phenotype,
  data = best2_descriptive_table1_data,
  render.continuous = c(. = "Mean [SD]", . = "Median [Q1, Q3]"),
  render.missing=NULL,
  render.categorical="FREQ (PCTnoNA%)")
```


```{r desc_table, echo=FALSE, fig.align='center'}
best2_table1
```

## Save dataset
```{r save_cleaned_data}
# write_csv(filtered_best2_baseline_meds_clean, 'data/processed/chapter.2_cleaned-best2-data.csv')
# write_csv(filtered_best2_baseline_meds_clean, 'data/processed/chapter.2_cleaned-best2-data_20221214.csv')
# write_csv(filtered_best2_baseline_meds_reflux, 'data/processed/chapter.2_cleaned-best2-data_20230209.csv')
# filtered_best2_baseline_meds_clean <- read_csv('data/processed/chapter.2_cleaned-best2-data.csv')

```

# Regression data

Common variables:

 - Age
 - Gender
 - BMI
 - Ethnicity
 - Smoking
 - NSAID
 - ACID_SUPPRESSANT
 - Duration_Reflux_Symptoms
 - Phenotype
 
```{r}
best2_cohort <-
  filtered_best2_baseline_meds_reflux %>%
  select(
    ID = patient_ID,
    Phenotype,
    age = age_at_be_diag_or_baseline,
    age_group,
    gender,
    ethnicity,
    bmi,
    bmi_group,
    smk_ever_smoked,
    taken_nsaids = TAKEN_NSAIDS,
    # NSAID_DURATION_YRS,
    # PPI,
    acid_suppressant = ACID_SUPPRESSANT,
    duration_since_heartburn_start,
    heartburn_inferred_bin
    # waist_to_hip_ratio
  )
```

## Save dataset

```{r}
# write_csv(best2_cohort, 'data/processed/chapter.2_regression_best2-cohort_cleaned-data_20221215.csv')
# write_csv(best2_cohort, 'data/processed/chapter.2_regression_best2-cohort_cleaned-data_20230208.csv')
# best2_cohort <- read_csv('data/processed/chapter.2_regression_best2-cohort_cleaned-dataset.csv')
```
# Thesis correction
## distribution of phenotype by site

```{r}
filtered_best2_baseline_meds_reflux <- read_csv('data/processed/chapter.2_cleaned-best2-data_20230209.csv')

best2_sites <- filtered_best2_baseline_meds_reflux %>%
  separate(
    col = patient_ID,
    into = c('ID_temp1', 'StudySite', 'ID_temp2'),
    sep = '/'
  ) %>%
  mutate(
    StudySite = case_when(StudySite %in% c("CTU", "PBH") ~ "CAM",
                          StudySite %in% c("PHH", "PWH") ~ "POR", 
                          TRUE ~ StudySite)
  ) %>% 
  mutate(
    region = case_when(

      StudySite %in% c("CAM", "WEL") ~ "East of England",
      StudySite %in% c("UCL", "STM") ~ "London",
      StudySite %in% c("NEW", "NTY", "STY", "NTE", "CDD") ~ "North East (England)",
      StudySite == "NOT" ~ "East Midlands (England)",
      StudySite == "POR" ~ "South East (England)",
      TRUE ~ "Other"
    )
  )
  
best2_sites %>% group_by(region, StudySite) %>% count()

table1::table1(~ StudySite | Phenotype, data = best2_sites)
table1::table1(~ region | Phenotype, data = best2_sites )


best2_sites %>% 
  finalfit::summary_factorlist(dependent = 'Phenotype', explanatory = 'region',  column = FALSE, total_col = T, orderbytotal = T) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(full_width = F)



best2_sites %>%
  unite('case_control_by_region', c(region, Phenotype), remove = FALSE) %>%
  select(
    c(
      'case_control_by_region',
      'age_at_be_diag_or_baseline',
      'gender',
      'bmi',
      'bmi_group', 
      'smk_ever_smoked',
      'TAKEN_NSAIDS',
      'heartburn_inferred_bin'    
      )
  ) %>%
  mutate(across(.cols = c(5:8), ~ as.character(.x))) %>%
  mutate(across(.cols = c(5:8), ~ replace_na(.x, "z_missing"))) %>%
  finalfit::summary_factorlist(
    dependent = 'case_control_by_region',
    explanatory = c(
      'age_at_be_diag_or_baseline',
      'gender',
      'bmi',
      'bmi_group', 
      'smk_ever_smoked',
      'TAKEN_NSAIDS',
      'heartburn_inferred_bin'
    ),
    column = TRUE,
    # na_include = TRUE,
    # na_to_prop = TRUE,
    total_col = T,
    # orderbytotal = T
  ) %>%
  select(-label) %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(full_width = F)
```


